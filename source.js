const audioContext=new(window.AudioContext||window.webkitAudioContext),referencefrequency=2e3;class Envelope{constructor(e,t,n){this.func=e,this.grainsize=t,this.duration=n}}class SoundManager{constructor(e,t){this.context=e,this.masterGainNode=e.createGain(),this.masterGainNode.gain.value=.1,this.masterAmbientGainNode=e.createGain(),this.masterAmbientGainNode.gain.value=.1,this.limiter=e.createDynamicsCompressor(),this.masterGainNode.connect(this.limiter),this.masterAmbientGainNode.connect(this.limiter),this.limiter.connect(this.context.destination),this.sources=Array(t),this.ambientsources=Array(t),this.oldestsource=0,this.nextsource=0,this.oldestambientsource=0,this.nextambientsource=0;for(let n=0;n<this.sources.length;n++)this.sources[n]=new SoundSource(this.context,this);for(let i=0;i<this.ambientsources.length;i++)this.ambientsources[i]=new SoundSource(this.context,this);this.limiter.threshold.value=-20,this.limiter.knee.value=0,this.limiter.ratio.value=20,this.limiter.attack.value=0,this.limiter.release.value=.25}requestSource(){let e=this.sources[this.oldestsource];return e.soundmaker&&(e.output.disconnect(),e.soundmaker.stop(),e.buffer=null),this.nextsource=e,this.oldestsource++,this.oldestsource>=this.sources.length&&(this.oldestsource=0),e}addEffect(e){this.effectschain||(this.effectschain=[]),this.effectschain.push(e),this.updateRouting()}updateRouting(){let e=this.masterGainNode;this.effectschain.forEach(function(t){e.connect(t),e=t}),e.connect(this.limiter)}requestAmbientSource(){let e=this.ambientsources[this.oldestambientsource];return e.soundmaker&&(e.output.disconnect(),e.soundmaker.stop(),e.buffer=null),this.nextambientsource=e,this.oldestambientsource++,this.oldestambientsource>=this.ambientsources.length&&(this.oldestambientsource=0),e}playSound(){this.soundmaker=this.nextsource,this.soundmaker.start(),this.soundmaker.output.connect(this.masterGainNode)}playAmbientSound(){this.ambientsoundmaker=this.nextambientsource,this.ambientsoundmaker.start(),this.ambientsoundmaker.output.connect(this.masterAmbientGainNode)}}class SoundSource{constructor(e,t,n,i,s,o,a,r,c){this.context=e,this.soundManager=t,this.type=n,this.freq=i,this.env=s,this.vol=o||1,this.fx=[],this.fxnodes=[],a&&(this.fx=a.slice()),this.overtones=[],r&&(this.overtones=r.slice()),this.overtonenoisemakers=[],this.overtonesoundmakers=[],this.freqmod=[],c&&(this.freqmod=c.slice()),this.gainNode=e.createGain(),this.limiter=this.context.createDynamicsCompressor(),this.masterGainNode=e.createGain(),this.output=this.masterGainNode,this.limiter.threshold.value=-10,this.limiter.knee.value=0,this.limiter.ratio.value=10,this.limiter.attack.value=.003,this.limiter.release.value=.25}start(){this.masterGainNode.gain.value=this.vol;let e=this;this.output.disconnect(),this.gainNode.disconnect(),this.soundmaker&&this.soundmaker.disconnect();let t=this.gainNode;if(this.gainNode.gain.value=0,this.gainNode.gain.setValueAtTime(0,this.context.currentTime),this.fxnodes.forEach(function(e){e.disconnect(),e.buffer=null}),this.fxnodes=[],this.fx.length>0&&this.fx.forEach(function(n,i){e.fxnodes.push(n()),t.connect(e.fxnodes[i]),t=e.fxnodes[i]}),t.connect(this.masterGainNode),"noise"===this.type||"lowpass-noise"===this.type||"lowpass-noise-white"===this.type){this.context.sampleRate;let n=this.context.sampleRate*this.env.duration,i=this.context.createBuffer(1,n,this.context.sampleRate),s=i.getChannelData(0);if("lowpass-noise-white"===this.type)for(let o=0;o<n;o++)s[o]=2*Math.random()-1;else{let a=0,r=0,c=Array(50).fill(0);for(let l=0;l<n;l++){let d=2*Math.random()-1;r-=c[l%50],c[l%50]=d;let $=(r+=d)/50;s[l]=(a+.02*$)/1.02,a=s[l],s[l]*=3.5}}if(this.noise=this.context.createBufferSource(),this.noise.buffer=i,this.noise.loop=!0,this.soundmaker=this.noise,"lowpass-noise"===this.type||"lowpass-noise-white"===this.type){let u=this.context.createBiquadFilter();u.type="lowpass",u.frequency.value=this.freq,this.lowpassFilter=u,this.soundmaker.connect(this.lowpassFilter),this.lowpassFilter.connect(this.gainNode)}else this.soundmaker.connect(this.gainNode)}else this.soundmaker=this.context.createOscillator(this.type,this.freq),this.soundmaker.type=this.type,this.soundmaker.frequency.value=this.freq,this.soundmaker.connect(this.gainNode);if(this.soundmaker.start(),this.env?(this.gainNode.gain.value=0,modulateparam(this.env,this.gainNode.gain,this.context,1),this.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime+this.env.duration)):console.log("error this sound played with no envelope"),this.freqmod&&("lowpass-noise"!==this.type&&"noise"!==this.type&&"lowpass-noise-white"!==this.type&&modulateparam(this.freqmod,this.soundmaker.frequency,this.context,this.freq),("lowpass-noise"==this.type||"lowpass-noise-white"==this.type)&&modulateparam(this.freqmod,this.lowpassFilter.frequency,this.context,this.freq)),this.overtonenoisemakers.forEach(function(e){e.disconnect(),e.stop()}),this.overtonesoundmakers.forEach(function(e){e instanceof OscillatorNode&&e.stop(),e.disconnect()}),this.overtonenoisemakers=[],this.overtonesoundmakers=[],this.overtones)for(let h=0;h<this.overtones.length;h++)"noise"!==this.type&&"lowpass-noise"!==this.type&&"lowpass-noise-white"!==this.type?(this.overtonesoundmakers.push(this.context.createOscillator(this.type)),this.overtonesoundmakers[h].start()):("lowpass-noise"==this.type||"lowpass-noise-white"==this.type)&&(this.overtonenoisemakers.push(this.context.createBufferSource()),this.overtonenoisemakers[h].buffer=this.noise.buffer,this.overtonenoisemakers[h].loop=!0,this.overtonesoundmakers.push(this.context.createBiquadFilter()),this.overtonenoisemakers[h].connect(this.overtonesoundmakers[h]),this.overtonenoisemakers[h].start()),this.overtonesoundmakers[h].frequency.setValueAtTime(this.freq*this.overtones[h],this.context.currentTime),this.overtonesoundmakers[h].connect(this.gainNode),this.freqmod&&(this.overtonesoundmakers[h].frequency.value=this.freq*this.overtones[h],modulateparam(this.freqmod,this.overtonesoundmakers[h].frequency,this.context,this.freq*this.overtones[h]))}}function modulateparam(e,t,n,i,s=!0){let{grainsize:o,duration:a,func:r}=e;t.cancelScheduledValues(n.currentTime);for(let c=0;c<a;c+=o*(.5*Math.random()+.5))t.linearRampToValueAtTime(r(c)*i,n.currentTime+c)}const soundManager=new SoundManager(audioContext,10);let verb=createReverb(audioContext,1)(),lowpass=createLowpassFilter(audioContext,1e4)(),delaychain=createDelayChain(audioContext,.25,.9,[lowpass,verb])();soundManager.effectschain=[delaychain],soundManager.updateRouting();const envelopes={random1sec:new Envelope(e=>Math.random(),.01,1),crack:new Envelope(e=>1,.01,.2),stab:new Envelope(e=>1,.01,.1),boom:new Envelope(e=>1,.1,.5),oldcrack:new Envelope(adsrconvert([.01,.05,1,.02],.01),.01,.3),rainfall:new Envelope(e=>Math.random(),.1,20),fire:new Envelope(e=>adsrconvert([3,.05,1,.02],90)(e)*(Math.random()/2+.5),.03,6),randomboom:new Envelope(e=>1*Math.random(),.1,1),randomstab:new Envelope(e=>Math.random()*Math.min(1,10*e),.1,.2),linearfall:new Envelope(e=>Math.max(1-e,.1),.2,1),linearfallhalf:new Envelope(e=>Math.max(1-4*e,0),.01,.5),negabsval:new Envelope(linearspike(1),.1,1)};let sounds={caveambience:[100,"lowpass-noise",envelopes.fire,[createReverb(audioContext,5)],new Envelope(e=>.5*Math.random()+.5,.1,1),[2,4,8],.25],deepspookybong:[100,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.01,1),[createReverb(audioContext,10)],new Envelope(e=>.1*Math.random()+.95,.1,1),[2.1],.1],highshrillbing:[1e3,"sine",new Envelope(linearspike(1),.01,1),[createReverb(audioContext,10)],new Envelope(e=>.1*Math.random()+.95,.1,1),[2.1],.1],footstep2:[100,"sine",envelopes.oldcrack,[createReverb(audioContext,.5)],null,[.5]],footstep:[500,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**.3*Math.random()**2,linearspike(.1)(Math.max(e-.15,0))**.3*Math.random()**2),.015,.3),[],null,[],.25],footstepverb:[500,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**.3*Math.random()**2,linearspike(.1)(Math.max(e-.15,0))**.3*Math.random()**2),.015,.3),[createReverb(audioContext,.5)],null,[],.25],weirdtone:[440,"sine",envelopes.random1sec,[],envelopes.randomboom,[2,4]],weirdnoise:[500,"lowpass-noise",envelopes.random1sec,[]],footsteptap:[100,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**15,linearspike(.1)(Math.max(e-.15,0))**15*Math.random()/2),.005,.3),[],null,[1.1,1.2,1.3,2],.25],footsteptapverb:[200,"lowpass-noise-white",new Envelope(e=>Math.max(linearspike(.1)(e)**15,linearspike(.1)(Math.max(e-.15,0))**15*Math.random()/2),.005,.3),[createReverb(audioContext,.5)],null,[1.1,1.2,1.3,2],.25],frogribbit:[1e3,"sine",new Envelope(e=>Math.max(linearspike(.1)(e)**25,linearspike(.1)(Math.max(e-.15,0))**25),.01,.3),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],softsine:[400,"sine",envelopes.negabsval,[]],arrowwhoosh:[400,"lowpass-noise-white",new Envelope(linearspike(.8),.01,.3),[],new Envelope(e=>Math.max(1-4*e,.5),.2,.5),[2]],arrowwhistle:[200,"sine",new Envelope(e=>linearspike(.8)(e)*Math.random(),.1,.3),[createReverb(audioContext,.2),createLowpassFilter(audioContext,200)],new Envelope(e=>Math.max(1-4*e,.8),.2,.5),[.9,.95,1.05,1.1]],arrowthudnoise:[150,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[createPause(audioContext,.2)],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],arrowthudtone:[150,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2),createPause(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],clubwhoosh:[400,"lowpass-noise-white",new Envelope(linearspike(.8),.01,.3),[],new Envelope(e=>Math.max(1-4*e,.5),.2,.5),[2]],clubwhoom:[200,"sine",new Envelope(e=>linearspike(.8)(e)*Math.random(),.1,.3),[createReverb(audioContext,.2),createLowpassFilter(audioContext,200)],new Envelope(e=>Math.max(1-4*e,.8),.2,.5),[.9,.95,1.05,1.1]],clubhitnoise:[100,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-5*e,0),.01,.4),[createPause(audioContext,.2)],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],clubhittone:[50,"sine",new Envelope(e=>Math.max(1-5*e,0),.01,.4),[createReverb(audioContext,.2),createPause(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],clubhitcrack:[100,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-2.5*e,0)*Math.random()**10,.005,.2),[createPause(audioContext,.2)],new Envelope(e=>1+100*e*Math.random(),.01,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2,4,8,16,32,64,128],.1],swordswingbig:[200,"lowpass-noise-white",new Envelope(linearspike(.4),.1,.4),[],new Envelope(e=>Math.max(1-6*e,.5)),[]],swordswingsmall:[400,"lowpass-noise-white",new Envelope(linearspike(.2),.1,.2),[],new Envelope(e=>Math.max(1-12*e,.25)),[]],swordswingxs:[600,"lowpass-noise-white",new Envelope(linearspike(.15),.1,.15),[],new Envelope(e=>Math.max(1-18*e,.2)),[]],swordswingsmallverb:[400,"lowpass-noise-white",new Envelope(linearspike(.2),.1,.2),[createReverb(audioContext,.5)],new Envelope(e=>Math.max(1-12*e,.25)),[]],deepthudnoise:[25,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-5*e,0),.01,.4),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],deepthudtone:[25,"sine",new Envelope(e=>Math.max(1-5*e,0),.01,.4),[createReverb(audioContext,.4)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],medthudnoise:[50,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],medthudtone:[50,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],drumtemplate:[50,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.1),[createReverb(audioContext,1)],new Envelope(e=>2*Math.random(),.005,.1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],1],stringplucktemplate:[600,"sine",new Envelope(e=>Math.max(1-3*e,0),.01,.5),[createReverb(audioContext,.2)],new Envelope(e=>Math.max(1-4*e,.25),.005,.5),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.5],stringsine:[440,"sine",new Envelope(linearspike(1),.01,1),[createReverb(audioContext,.2)],new Envelope(e=>.95+.025*Math.random(),.1,1),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2]],highthudnoise:[150,"lowpass-noise",new Envelope(e=>e**.01*Math.max(1-10*e,0),.01,.2),[],null,[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],highthudtone:[150,"sine",new Envelope(e=>Math.max(1-10*e,0),.01,.2),[createReverb(audioContext,.2)],new Envelope(e=>2*Math.random(),.005,.2),[1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9,2],.1],bassdrum:[100,"sine",new Envelope(e=>linearspike(.08)(e)*Math.random(),.01,.1),[createReverb(audioContext,2)],null,[1.1,1.2,.5],2],snaredrum:[200,"lowpass-noise-white",new Envelope(e=>linearspike(.04)(e)*Math.random(),.01,.1),[],null,[1.1,1.2,.5],2],whee:[2e3,"lowpass-noise",new Envelope(linearspike(.5),.01,.5),[],new Envelope(linearspike(.5),.01,.5),[]],goblinchat:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[],new Envelope(e=>Math.random()**2*2,5e-4,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.01],goblinchatverb:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,5e-4,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.01],goblinchat2:[400,"sine",new Envelope(e=>linearspike(1)(e)**.01*Math.random()**2,.05,1),[],new Envelope(e=>Math.random()**2*2,.002,1),[1.1,1.2,.9,.8,.4,.3,2.2,3.3],.02],goblinchat2old:[400,"sine",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**2,.05,1.5),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,.002,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],goblinchat3old:[600,"sine",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**2,.05,1.5),[createReverb(audioContext,.1)],new Envelope(e=>Math.random()**2*2,.003,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],something:[2,"noise",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random(),5e-5,1.5),[createReverb(audioContext,.1)],new Envelope(e=>5*Math.random(),.01,1.5)],goblinchatnoise:[800,"lowpass-noise-white",new Envelope(e=>linearspike(1.5)(e)**.01*Math.random()**4,.05,1.5),[],new Envelope(e=>Math.random()**2*2,.0025,1.6),[1.1,1.2,.9,.8,.4,.3,2.2,3.3]],goblinscream:[400,"sine",new Envelope(e=>linearspike(1.5)(e)**.01,.05,1.5),[],new Envelope(e=>Math.random()**2*2,.0025,1.5),[1.5,1.6,.5,.6,.4,.3],.05],goblinyelpold:[800,"sine",new Envelope(e=>linearspike(.25)(e)**.01,.005,.25),[],new Envelope(e=>Math.random()**2*2,5e-4,.5),[1.5,1.6,.5,.6,.4,.3],.01],goblindeath:[800,"sine",new Envelope(e=>e**.2*(1-e)*Math.random()**.5,.01,1),[createDistortion(audioContext,1)],new Envelope(e=>e**.2*Math.random()**.5*2*(1-e/4)*Math.random()*2,.005,5),[1.5,1.6,.5,.6,.4,.3],.05],goblinyelp:[800,"sine",new Envelope(e=>linearspike(.25)(e)**.01,.005,.25),[],new Envelope(e=>Math.random()**2*2,.005,.5),[1.5,1.6,.5,.6,.4,.3],.01],rustle:[500,"lowpass-noise-white",envelopes.randomstab,[]],rustleverb:[500,"lowpass-noise-white",envelopes.randomstab,[createReverb(audioContext,.5)]],eeesound:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,300)],null,[.5,2,3,4,5,6,7,8,9,10,12]],eeesound2:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,2200)],null,[.5,2,3,4,5,6,7,8,9,10,12]],eeesound3:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,3e3)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,1e3)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound2:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,1300)],null,[.5,2,3,4,5,6,7,8,9,10,12]],aaasound3:[125,"sawtooth",new Envelope(e=>linearspike(.25)(e)**.25*(.5+Math.random()/2),.005,3),[createReverb(audioContext,.25),createBandpassFilter(audioContext,2400)],null,[.5,2,3,4,5,6,7,8,9,10,12]],sine:[75,"sine",new Envelope(e=>linearspike(.08)(e)*Math.random(),.01,.1),[createDistortion(audioContext,25)]],bowstring:[100,"lowpass-noise-white",new Envelope(e=>linearspike(1)(e)*Math.random()**10,5e-4,1),[],new Envelope(e=>Math.min(Math.max((10*e)**2,0),25),.1,1),[],.1],treecreakinginthewind:[100,"lowpass-noise-white",new Envelope(e=>linearspike(5)(e)**4*Math.random()**.5,15e-5,5)],tap:[100,"lowpass-noise-white",new Envelope(e=>linearspike(.5)(e)**4*Math.random()**.5,2e-4,.5)],sworddraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.5)(e)*Math.random()**.2,.01,1),[],new Envelope(e=>Math.min(200*(e+1),75),.01,1),[.5,1/4],.05],swordring:[800,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.5)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.01],swordring2:[800/3,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.75)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.1],swordring3:[200,"sine",new Envelope(e=>linearspike(1)(e)*Math.random(),.03,1),[createReverb(audioContext,.5)],new Envelope(e=>Math.min(10*e,1),.01,1),[],.025],shortsworddraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.35)(e)*Math.random()**.2,.01,.5),[],new Envelope(e=>Math.min(300*(e+1),100),.01,.5),[],.05],daggerdraw:[25,"lowpass-noise-white",new Envelope(e=>linearspike(.25)(e)*Math.random()**.4,.01,.5),[],new Envelope(e=>Math.min(400*(e+1),100),.01,.5),[],.05],puncture:[2500,"lowpass-noise-white",new Envelope(e=>linearspike(.25)(e)*Math.random()**.3,.01,.5),[],new Envelope(e=>1-2*e,.01,.5),[],.1],spurt1:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**2*Math.random()**2,.001,1),[createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[1.1,1.2,1.3,2,4,8],.1],spurt2:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**2*Math.random()**2,.001,1),[createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[6,12],.1],spurt1verb:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**4*Math.random()**2,.001,1),[createReverb(audioContext,.2),createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[1.1,1.2,1.3,2,4,8],.5],spurt2verb:[50,"lowpass-noise-white",new Envelope(e=>linearspike(.2)(e)**4*Math.random()**2,.001,1),[createReverb(audioContext,.2),createPause(audioContext,.1)],new Envelope(e=>Math.max((e+1)*2*Math.random()**2*4,1),.01,.5),[6,12],.5],woodbreaking:[100,"lowpass-noise-white",new Envelope(e=>(1-e/.7)*Math.random()**(2*e),15e-5,.7),[],new Envelope(e=>(e+1)*Math.random(),.01,.7),[1.1,1.5,2,4],.2],woodbreaking2:[100,"lowpass-noise-white",new Envelope(e=>(1-e/2)*Math.random()**(10*e+1),.01,2),[createReverb(audioContext,.1)],new Envelope(e=>Math.max(Math.random()**4*16,.5),.01,1.5),[1.1,1.5,2,4],.2]};function linearspike(e){return function(t){return 0==t||t>e?0:t<=e/2?t/(e/2):1-(t-e/2)/(e/2)}}const soundeffects={footstep:[sounds.footstep,sounds.footsteptap],footsteptap:[sounds.footsteptap,sounds.footsteptapverb],arrowflight:[sounds.arrowthudnoise,sounds.arrowthudtone,sounds.swordswingsmall,sounds.swordswingsmallverb],swordswing:[sounds.swordswingsmall,sounds.swordswingsmallverb],swordhit:[sounds.swordswingsmall,sounds.swordswingsmallverb,sounds.medthudtone,sounds.medthudnoise],clubswing:[sounds.clubwhoom,sounds.clubwhoosh],clubhit:[sounds.clubhitcrack,sounds.clubhittone,sounds.clubhitcrack,sounds.clubwhoom,sounds.clubwhoosh],woodbreaking:[sounds.woodbreaking,sounds.woodbreaking2],caveambience:[sounds.caveambience],deepspookybong:[sounds.deepspookybong],highshrillbing:[sounds.highshrillbing],bassdrum:[sounds.bassdrum],highthud:[sounds.highthudtone,sounds.highthudnoise],medthud:[sounds.medthudtone,sounds.medthudnoise],deepthud:[sounds.deepthudtone,sounds.deepthudnoise],goblinchat:[sounds.goblinchat,sounds.goblinchatverb,sounds.goblinchat2],goblinyelp:[sounds.goblinyelp],goblindeath:[sounds.goblindeath],goblinscream:[sounds.goblinscream],aaasound:[sounds.aaasound,sounds.aaasound2,sounds.aaasound3],eeesound:[sounds.eeesound,sounds.eeesound2,sounds.eeesound3],sworddraw:[sounds.sworddraw,sounds.swordring,sounds.swordring2,sounds.swordring3],bowdraw:[sounds.bowstring],shortsworddraw:[sounds.shortsworddraw],daggerdraw:[sounds.daggerdraw],tap:[sounds.tap],puncture:[sounds.puncture,sounds.spurt1,sounds.spurt2,sounds.spurt1verb,sounds.spurt2verb]};function playsoundeffect(e){e.forEach(function([e,t,n,i,s,o,a]){let r=soundManager.requestSource();r.freqmod=null,r.overtones=[],s&&(r.freqmod=s),o&&(r.overtones=o.slice()),r.vol=1,void 0!==a&&(r.vol=a),r.freq=null,r.freq=e,r.type=null,r.type=t,r.env=null,r.env=n,r.fx=[],i&&(r.fx=i.slice()),soundManager.playSound()})}function playambientsound(e){e.forEach(function([e,t,n,i,s,o,a]){let r=soundManager.requestAmbientSource();r.freqmod=null,r.overtones=[],s&&(r.freqmod=s),o&&(r.overtones=o.slice()),r.vol=.2,a&&(r.vol=a/5),r.freq=null,r.freq=e,r.type=null,r.type=t,r.env=null,r.env=n,r.fx=[],i&&(r.fx=i.slice()),soundManager.playAmbientSound()})}function adsrconvert([e,t,n,i],s){let o=s-(e+t+i);return function(s){return s<0?0:s>=0&&s<=e?s/e:s>e&&s<=e+t?1-(s-e)/t*(1-n):s>e+t&&s<=e+t+o?n:s>e+t+o&&s<=e+t+o+i?n*(1-(s-(e+t+o))/i):0}}function calculateGain(e,t,n){let i=t/2/1024,s=new Float32Array(1024),o=new Float32Array(1024),a=new Float32Array(1024);for(let r=0;r<1024;r++)s[r]=r*i;e.getFrequencyResponse(s,o,a);let c=0,l=0;for(let d=0;d<1024;d++)c+=1,l+=o[d];let $=c*i*n,u=l*i*n;return Math.sqrt($/u)}function createReverb(e,t=2){return function(){let n=e.createConvolver(),i=e.sampleRate,s=i*t,o=e.createBuffer(2,s,i),a=o.getChannelData(0),r=o.getChannelData(1);for(let c=0;c<s;c++)a[c]=(2*Math.random()-1)*Math.pow(1-c/s,2),r[c]=(2*Math.random()-1)*Math.pow(1-c/s,2);return n.buffer=o,n.normalize=!0,n}}function createDistortion(e,t){return function(){let n=e.createWaveShaper();return n.curve=makeSoftClippingCurve(t),n}}function makeDistortionCurve(e){let t="number"==typeof e?e:50,n=new Float32Array(44100),i=Math.PI/180;for(let s=0;s<44100;++s){let o=2*s/44100-1;n[s]=(3+t)*o*20*i/(Math.PI+t*Math.abs(o))}return n}function makeSoftClippingCurve(e){let t="number"==typeof e?e:50,n=new Float32Array(44100);for(let i=0;i<44100;++i){let s=2*i/44100-1;n[i]=s/(1+t*Math.abs(s))}return n}function makeExponentialDistortionCurve(e){let t="number"==typeof e?e:50,n=new Float32Array(44100);for(let i=0;i<44100;++i){let s=2*i/44100-1;n[i]=(1-Math.exp(-t*Math.abs(s)))*(s<0?-1:1)}return n}function createDelay(e,t=1,n=.5){return function(){let i=e.createDelay(),s=e.createGain();return s.gain.value=n,i.connect(s),s.connect(i),i.delayTime.value=t,s}}function createPause(e,t=1,n=0){return function(){let i=e.createDelay(),s=e.createGain();return s.gain.value=n,i.connect(s),s.connect(i),i.delayTime.value=t,i}}function createDelayChain(e,t=1,n=.5,i){return function(){let s=e.createDelay(),o=e.createGain();o.gain.value=n,s.connect(o);let a=o;return i.forEach(function(e){a.connect(e),a=e}),a.connect(s),s.delayTime.value=t,o}}function createLowpassFilter(e,t){return function(){let n=e.createBiquadFilter();return n.frequency.setValueAtTime(t,e.currentTime),n.type="lowpass",n}}function createBandpassFilter(e,t){return function(){let n=e.createBiquadFilter();return n.type="bandpass",n.frequency.value=t,n.Q.value=1,n}}class ambientSound{constructor(e,t,n){this.sound=e,this.mincadence=t,this.maxcadence=n,this.lastplayed=0,this.thiscadence=t+Math.random()*(n-t),this.randomize=!0}}let ambientsounds=[new ambientSound(soundeffects.caveambience,5e3,7e3),new ambientSound(soundeffects.deepspookybong,5e3,15e3),new ambientSound(soundeffects.bassdrum,1500,1500)];function updateambientsound(){ambientsounds.forEach(function(e){performance.now()-e.lastplayed>e.thiscadence&&(!0==e.randomize&&(e.sound[0][0]=1e3*Math.random()),playambientsound(e.sound),e.lastplayed=performance.now(),e.thiscadence=e.mincadence+Math.random()*(e.maxcadence-e.mincadence))})}ambientsounds[2].randomize=!1;class character{constructor(e,t,n,i,s,o,a,r,c,l,d,$){this.pos=[],this.pos=e.slice(),this.name=t,this.stats=n||[0,0,0],this.maxhp=i,this.hp=i,this.tcmax=s.slice(),this.tcmax.length<4&&(this.tcmax[3]=1),this.tc=this.tcmax.slice(),this.pc=o,this.symbol=a,this.dead=!1,this.actionqueue=[],this.target=e.slice(),this.color=r.slice(),this.ac=c,this.traits=l.map(e=>new trait(e.name,e.trigger,e.effect,e.active,e.passive,this)),this.conditions=[],this.condresists=[],this.unarmed=new Unarmed,this.equipment=[],d&&d.length>0&&(this.equipment=d.slice()||[]),this.primaryitem=this.unarmed,this.secondaryitem=this.unarmed,this.offhanditem=this.unarmed,this.ammunition={};let u=this;this.equipment.forEach(function(e){u.addItem(e)}),this.specialattack=$||null,this.lightsources=[],this.index=characterindex,characterindex++,this.visibletiles=[],!0==this.pc?playercs.push(this):nonpcs.push(this)}damage(e){adduilabel(e.toString(),this.pos,[128,0,0],1,!0),addToLog(`${this.symbol} hit for ${e}`),this.hp-=e,this.hp<=0&&!1==this.dead&&this.die();let t=new blood("Blood","",[0,0,0],[.5,.1,.1],0,!0,0);newgrid[this.pos[0]][this.pos[1]].addFluid(t)}heal(e){this.hp+=e,adduilabel(e.toString(),this.pos,[0,128,0],1,!0,!1,!1,!0,1)}die(){let[e,t]=this.pos;this.actionqueue=[];let n=null;this.deathsound&&(n=this.deathsound),this.actionqueue.push(new action("Die",e=>e,[0,0,0],0,this.pos,this,this.pos,[],n,6)),move(this),this.dead=!0,adduilabel("x",this.pos,[128,0,0],0,!0),this.color[1]*=.5,this.color[2]*=.5,this.color[0]*=.5;let i=new corpse("Corpse",this.symbol,convertColortoAbs(this.color).map((e,t)=>e*materials.blood[t]),null,0,!0,0);i.destructable=!1,newgrid[this.pos[0]][this.pos[1]].addObject(i),this.dropAll()}addItem(e){if(e instanceof Ammunition){this.addAmmo(e.basename,e.number);return}if(e instanceof Light){this.offhanditem&&this.offhanditem.basename!==this.unarmed.basename&&this.dropoffhand(),this.offhanditem=e;return}if(this.primaryitem&&this.primaryitem.basename==e.basename&&this.primaryitem.stacksize>this.primaryitem.number)this.primaryitem.number++,this.primaryitem.name=`${this.primaryitem.basename}(${this.primaryitem.number})`,adduilabel(this.primaryitem.name,this.pos,this.color,1,!0);else if(this.secondaryitem&&this.secondaryitem.basename==e.basename&&this.secondaryitem.stacksize>this.secondaryitem.number)this.secondaryitem.number++,this.secondaryitem.name=`${this.secondaryitem.basename}(${this.secondaryitem.number})`,adduilabel(this.secondaryitem.name,this.pos,this.color,1,!0);else{if(this.secondaryitem.name==this.unarmed.name&&this.itemSwap(),this.drop(),this.primaryitem=e,e.ammotype){let t=this.ammunition[e.ammotype];t||(t=0),e.name=`${e.basename}(${t})`}adduilabel(this.primaryitem.name,this.pos,this.color,1,!0)}}itemSwap(){let e=this.primaryitem;this.primaryitem=this.secondaryitem,this.secondaryitem=e}drop(){let[e,t]=this.pos;if(this.primaryitem&&this.primaryitem.basename!=this.unarmed.basename){if(this.primaryitem.ammotype){let n=this.ammunition[this.primaryitem.ammotype];this.ammunition[this.primaryitem.ammotype]=0;let i=new this.primaryitem.ammoconstructor;i.number=n,newgrid[e][t].addObject(i)}newgrid[e][t].addObject(this.primaryitem),this.primaryitem=this.unarmed}}dropoffhand(){let[e,t]=this.pos;this.offhanditem&&this.offhanditem.basename!=this.unarmed.basename&&(newgrid[e][t].addObject(this.offhanditem),this.offhanditem=this.unarmed)}dropAll(){let[e,t]=this.pos;if(this.primaryitem&&this.primaryitem.basename!==this.unarmed.basename){if(this.primaryitem.ammotype){let n=this.ammunition[this.primaryitem.ammotype];this.ammunition[this.primaryitem.ammotype]=0;let i=new this.primaryitem.ammoconstructor;i.number=n,newgrid[e][t].addObject(i)}newgrid[e][t].addObject(this.primaryitem),this.primaryitem=this.unarmed}if(this.secondaryitem&&this.secondaryitem.basename!==this.unarmed.basename){if(this.secondaryitem.ammotype){let s=this.ammunition[this.secondaryitem.ammotype];this.ammunition[this.secondaryitem.ammotype]=0;let o=new this.secondaryitem.ammoconstructor;o.number=s,newgrid[e][t].addObject(o)}newgrid[e][t].addObject(this.secondaryitem),this.secondaryitem=this.unarmed}}removeItem(e){this.primaryitem.basename==e.basename&&(this.primaryitem.number--,this.primaryitem.number<=0?this.primaryitem=this.unarmed:adduilabel(this.primaryitem.number.toString(),this.pos,this.color,1,!0),1==this.primaryitem.number?this.primaryitem.name=this.primaryitem.basename:this.primaryitem.number>1&&(this.primaryitem.name=`${this.primaryitem.basename}(${this.primaryitem.number})`))}removeAmmo(e){this.ammunition[e]--,adduilabel(this.ammunition[e].toString(),this.pos,this.color,1,!0),this.updateAmmo()}addAmmo(e,t){!this.ammunition[e]||this.ammunition[e]<=0?this.ammunition[e]=t:this.ammunition[e]+=t,adduilabel(this.ammunition[e].toString(),this.pos,this.color,1,!0),this.updateAmmo()}updateAmmo(){let e=[this.primaryitem,this.secondaryitem],t=this;e.forEach(function(e){e.ammotype&&(t.ammunition[e.ammotype]||(t.ammunition[e.ammotype]=0),e.name=`${e.basename}(${t.ammunition[e.ammotype]})`)})}getatkbonus(e=this.primaryitem){let t=e.bonus+this.stats[e.stat];return t}getdamage(){let e=this.primaryitem,t=e.bonus+this.stats[e.stat],n=roll(e.damagedie,t);return n}getavdamage(e=this.primaryitem){let t=e.bonus+this.stats[e.stat],n=[1+t,e.damagedie+t];return n}getrange(e=this.primaryitem){return e.ammotype&&!this.ammunition[e.ammotype]?0:e.range}getminrange(e=this.primaryitem){return e.minrange}getvisibletiles(){let[e,t]=this.pos,n=this,i=[],s=[],o=new Set;s.push(newgrid[e][t]);let a=0;for(this.visibletiles.length>0&&this.visibletiles.forEach(e=>e.removevisiblecharacter(n));s.length>0&&a<1e3;){a++;let r=s.shift(),[c,l]=r.pos;if(!1!==drawline([e,t],[c,l])){i.push(r),r.addvisiblecharacter(n);let d=`${r.pos[0]},${r.pos[1]}`;n.knowntiles[d]=turncounter;for(let $=c-1;$<=c+1;$++)for(let u=l-1;u<=l+1;u++){let h=`${$},${u}`;!o.has(h)&&newgrid[$]&&newgrid[$][u]&&(o.add(h),s.push(newgrid[$][u]))}}}this.visibletiles=i}getplayerviewold(){let[e,t]=this.pos,n=[e,t],i=[],s={},o=[];o.push(newgrid[e][t]);let a=0;class r{constructor(e,t,n){this.min=e,this.max=t,this.distance=n,this.left=null,this.right=null}}class c{constructor(){this.root=null}insert(e,t,n){let i=new r(e,t,n);null===this.root?this.root=i:this.root=this._insert(this.root,i)}_insert(e,t){return t.min<e.min?null===e.left?e.left=t:e.left=this._insert(e.left,t):null===e.right?e.right=t:e.right=this._insert(e.right,t),e}find(e){return this._find(this.root,e)}_find(e,t){return null===e?null:t>=e.min&&t<=e.max?e.distance:t<e.min?this._find(e.left,t):this._find(e.right,t)}findMaxDistanceInRange(e,t){return this._findMaxDistanceInRange(this.root,e,t)}_findMaxDistanceInRange(e,t,n){if(null===e||e.max<t||e.min>n)return -99;if(e.min>=t&&e.max<=n)return e.maxDistance;let i=-99;return e.min<=n&&e.max>=t&&(i=e.distance),i=Math.max(i,this._findMaxDistanceInRange(e.left,t,n),this._findMaxDistanceInRange(e.right,t,n))}}let l=Array(360).fill(99);function d(e,t){let[n,i]=e,[s,o]=t,a=[[s-.5,o-.5],[s+.5,o-.5],[s-.5,o+.5],[s+.5,o+.5]].map(([e,t])=>{let s=Math.atan2(t-i,e-n)*(180/Math.PI);return Math.round(s=(s+360)%360)}),r=Math.min(...a),c=Math.max(...a);return Math.abs(r-c)>270?[r,r,chebyshevDistance(e,t)]:[r,c,chebyshevDistance(e,t)]}function $(e){let[t,i]=e.pos,s=d(n,e.pos);console.log(l);let o=l.findMaxDistanceInRange(s[0],s[1]);return!!(o>=s[2])||-99===o}function u(e){let t=d(n,e.pos);for(let i=t[0];i<=t[1];i++)if(t[2]<=l[i])return!0;return!1}for(;o.length>0&&a<5e3;){let h=o.shift(),[p,m]=h.pos;if(a++,i.push(h),newgrid[p][m].symbolBase="q",!1!=u(h)){if(newgrid[p][m].symbolBase="e",1>h.readOpacity())for(let _=p-1;_<=p+1;_++)for(let f=m-1;f<=m+1;f++)s[_]||(s[_]={}),s[_][f]||(s[_][f]=1,o.push(newgrid[_][f]));if(h.readOpacity()>=1){let g=d(n,h.pos);for(let w=g[0];w<=g[1];w++)l[w]=Math.min(l[w],g[2])}}}return i.forEach(function(e){}),i}getplayerview(){let[e,t]=this.pos,n=[e,t],i=[],s={},o=[];o.push(newgrid[e][t]);let a=0,r=Array(360).fill(99);function c(e,t){let[n,i]=e,[s,o]=t,a=[[s-.5,o-.5],[s+.5,o-.5],[s-.5,o+.5],[s+.5,o+.5]].map(([e,t])=>{let s=Math.atan2(t-i,e-n)*(180/Math.PI);return Math.round(s=(s+360)%360)}),r=Math.min(...a),c=Math.max(...a);return Math.abs(r-c)>270?[r,r,chebyshevDistance(e,t)]:[r,c,chebyshevDistance(e,t)]}function l(e){let t=c(n,e.pos);for(let i=t[0];i<=t[1];i++)if(t[2]<=r[i])return!0;return!1}for(;o.length>0&&a<500;){let d=o.shift(),[$,u]=d.pos;if(a++,i.push(d),!1!=l(d)){if(1>d.readOpacity())for(let h=$-1;h<=$+1;h++)for(let p=u-1;p<=u+1;p++)s[h]||(s[h]={}),s[h][p]||(s[h][p]=1,o.push(newgrid[h][p]));if(d.readOpacity()>=1){let m=c(n,d.pos);for(let _=m[0];_<=m[1];_++)r[_]=Math.min(r[_],m[2])}}}return console.log(a),i}hear(e,t){if(this.dead||!0===e.heard)return;let n=this,[i,s]=e.pos;e.heard=!0;let o=[];e.soundeffect&&(o=e.soundeffect.slice());let a=[];if(o.forEach(function(n,i){a[i]=[],a[i]=n.slice(),void 0===a[i][6]&&(a[i][6]=1),0!==a[i][6]&&(a[i][6]*=Math.min((t/e.volume)**.5,1))}),!0==e.origin.pc){playsoundeffect(a);return}if(!1==newgrid[i][s].visible){setTimeout(()=>{adduilabel("^",e.pos,n.color,0,!0,!1,!1,!0,1),playsoundeffect(a)},(e.volume-t)*50);return}playsoundeffect(a)}}class playerCharacter extends character{constructor(e,t,n,i,s,o,a,r,c,l,d,$){super(e,t,n,i,s,o,a,r,c,l,d,$),this.reactions=[attackofop,overwatch,autopickup]}}class enemy extends character{constructor(e,t,n,i,s,o,a,r,c,l,d,$,u){super(e,t,n,i,s,o,a,r,c,l,d,u),this.startingpos=e.slice(),this.knowntiles={},this.tasks=[],this.knownenemies=[],this.activetask,this.huntmap,this.huntedcharacters={},this.knowncharacters={},this.visiblecharacters={},this.utilityfunctions=[],this.actions=[],this.reactions=$||[],this.hp+=Math.round(4*Math.random()),this.maxhp=this.hp,this.actions=[moveusecase,attackusecase,dashusecase,chatusecase,standgroundusecase,alertusecase],this.states=[new State("idle",defaultidle,null,[0,3]),new State("hostile",defaulthostile,defaulttemperment,[0,1,2]),new State("hunting",defaulthunting,null,[0,2]),new State("fleeing",defaultfleeing,null,[0,1,2,5])],this.updatestate(),this.deathsound=soundeffects.goblindeath}damage(e){super.damage(e),!1==this.dead&&this.hp<=Math.ceil(this.maxhp/4)&&(this.state=this.states[3])}updatestate(){let e=this;this.state||(this.state=this.states[0]);let t=!1,n=!1;Object.values(this.visiblecharacters).forEach(function(i){let s=i.character;s.pc!==e.pc&&(t=!0,n=!0)}),t||Object.values(this.knowncharacters).forEach(function(t){let i=t.character;i.pc!==e.pc&&(n=!0)}),this.state.name==this.states[0].name&&!0==t&&(addconditiondynamic(conditions.Surprised,!0,this)(),this.state=this.states[1],this.actionqueue=[]),this.state.name==this.states[1].name&&!1==n?(this.huntmap=null,this.state=this.states[2],this.actionqueue=[]):this.state.name!=this.states[2].name||(!0==t&&(this.state=this.states[1],this.actionqueue=[]),this.huntedcharacters&&this.huntedcharacters.length)}hear(e,t){let n=this;if(e.origin!=n){if(e.origin.pc!==this.pc)this.visiblecharacters[e.origin.index]=new CharacterMemory(e.origin,e.origin.pos.slice()),this.knowncharacters[e.origin.index]=new CharacterMemory(e.origin,e.origin.pos.slice()),this.updatestate();else if("Attack"==e.content||"Miss"==e.content){let[i,s]=e.pos,o;newgrid[i][s].character&&newgrid[i][s].character.pc!==this.pc&&(o=newgrid[i][s].character),o&&(this.visiblecharacters[o.index]=new CharacterMemory(o,o.pos.slice()),this.knowncharacters[o.index]=new CharacterMemory(o,o.pos.slice())),this.updatestate()}else("Alert"==e.content||"Huh?"==e.content)&&(e.origin.knowncharacters?Object.values(e.origin.knowncharacters).forEach(function(e){let t=e.character,i=e.lastseen;if(!n.visiblecharacters[t.index]||n.visiblecharacters[t.index].time<e.time){let s=new CharacterMemory(t,i);n.visiblecharacters[t.index]=s,n.updatestate()}}):console.log("trying to alert, but don't know any enemies"))}}getrange(e=this.primaryitem){let t=super.getrange();return!0==e.throwable&&e.number<2&&(t=1.9),t}}class Goblin extends enemy{constructor(e,t,n,i){super(e,t,statblocks.Goblin,4,[5,1,1],!1,"g",n,8,[traits.LightSensitive],i,[spot,attackofop],darkattackpermute)}}class Goblin_Dagger extends Goblin{constructor(e){let t;super(e,"Goblin",[150,125,0],[t=Math.random()>.5?new Dagger(1):new Javelin(1)])}}class Goblin_Shortbow extends Goblin{constructor(e){super(e,"Goblin Archer",[100,150,0],[new Shortbow]),this.ammunition.Arrow=randomNumber(5,2)}}class Ogre extends enemy{constructor(e){super(e,"Ogre",[3,0,4],12,[3,1,1],!1,"o",[150,125,0],8,[traits.LightSensitiveMild],[new Warhammer],[spot,attackofop],darkattackpermute)}}class Giant extends enemy{constructor(e){super(e,"Giant",[3,0,4],24,[3,1,1],!1,"G",[150,125,0],8,[traits.LightSensitiveMild],[new Polehammer],[spot,attackofop],darkattackpermute)}}class Skulker extends enemy{constructor(e){super(e,"Skulker",[0,2,0],5,[10,1,1],!1,"s",[32,32,32],12,[traits.LightSensitive],[new Bolas(randomNumber(3,1))],[spot,attackofop],darkattackpermute)}}class Wolf extends enemy{constructor(e){super(e,"Wolf",[0,0,0],5,[8,2,1],2,"w",[64,64,64],8,[],[new Weapon(...items.Dagger)],[spot,attackofop])}}class Carrion_Insect extends enemy{constructor(e){super(e,"Carrion Insect",[0,0,0],5,[8,2,1],2,"c",[128,128,128],8,[],[new Weapon(...items.Dagger)],[spot,attackofop])}}class State{constructor(e,t,n,i){this.name=e,this.utilityfunction=t,this.temperment=n||function(){return 0},this.actions=[],i&&(this.actions=i.slice())}}class CharacterMemory{constructor(e,t){this.character=e,this.lastseen=t.slice(),this.time=turncounter}getage(){return turncounter-this.time}}class Statblock{constructor(e,t,n){this.strength=e,this.dexterity=t,this.constitution=n}}class lightsource{constructor(e,t,n,i){this.pos=e,this.color=t,this.lightpref=n,this.radiance=i||2}}class uielement{constructor(e,t,n,i,s){this.symbol=e||"",this.color=t,this.pos=n,this.animation=i||!1,this.symbol||(this.symbol="$"),this.ui=s||!1}}class PriorityQueue{constructor(e=(e,t)=>e-t){this.array=[],this.comparator=e}enqueue(e){this.array.push(e),this.array.sort(this.comparator)}dequeue(){return this.array.shift()}isEmpty(){return 0===this.array.length}}class condition{constructor(e,t,n,i,s,o,a){this.name=e,this.starteffect=t||(()=>{}),this.turneffect=n||(()=>{}),this.duration=i,this.resistance=s,this.character=a||null,this.endeffect=o}}class trait{constructor(e,t,n,i,s,o){this.name=e,this.trigger=t,this.effect=n,this.character=o||null,this.passive=i||!1,this.active=s||!1}}class trigger{constructor(e,t,n){this.isactive=e,this.ispassive=t,this.cb=n}}class action{constructor(e,t,n,i,s,o,a,r,c,l){this.name=e,this.target=s.slice(),this.func=t,this.character=o,this.cost=n,this.range=i||1.9,this.pos=a||null,this.warnings=[],r&&(this.warnings=r.slice()),this.soundeffect=c,this.loudness=l||1,this.reactable=!0}}class Move extends action{constructor(e,t,n,i,s,o,a,r){super(e,t,n,i,s,o,a,r);let[c,l]=this.target;if(this.cost[0]=newgrid[c][l].moveCost,this.pos&&this.character&&this.target){checkforaoomove(this.pos,this.target,this.character)&&this.warnings.push("Attack of Opportunity"),newgrid[c][l].objects.length>0&&newgrid[c][l].objects[0].burning&&this.warnings.push("Hazard");let d=this;newgrid[c][l].fluids.forEach(function(e){e.burning&&d.warnings.push("Hazard")})}this.loudness=6,this.character.state&&(this.character.state.name,this.character.states[0].name),this.soundeffect=soundeffects.footstep,"Smooth Stone Floor"==newgrid[c][l].name&&(this.soundeffect=soundeffects.footsteptap),"Ogre"==o.name&&(this.soundeffect=soundeffects.deepthud,this.loudness=12)}}class Attack extends action{constructor(e,t,n,i,s,o,a,r){super(e,t,n,i,s,o,a,r),this.range=i;let[c,l]=this.target;this.pos&&this.character&&this.target&&checkforaooattack(this.pos,this.target,this.character)&&this.warnings.push("Attack of Opportunity"),this.loudness=9}}class Get extends action{constructor(e,t,n,i,s,o,a,r,c,l){super(e,t,n,i,s,o,a,r,c,l),this.reactable=!1}}class endTurn extends action{constructor(e,t,n,i,s,o,a,r){if(super(e,t,n,i,s,o,a,r),this.pos){let[c,l]=this.pos;newgrid[c][l].objects.length>0&&newgrid[c][l].objects[0].burning&&this.warnings.push("Hazard")}}}class Tile{constructor(e,t,n,i,s,o,a){this.name=e,this.absorbtionBase=t,this.symbolBase=n,this.visible=!1,this.light=[0,0,0],this.lightlevel=0,this.objects=[],this.items=[],this.character=null,this.uiElements=[],this.traversable=i,this.moveCost=s,this.baseMoveCost=s,this.pos=a,this.transparancy=o,this.specularity=0,this.charactersinview=[],this.fluids=[],this.elevation=0}read(){let[e,t]=this.pos,n=this.light.slice(),i=this,s=!1,o=10;if(playercs.forEach(function(e){let[t,n]=e.pos,a=i.elevation-newgrid[t][n].elevation;(a<=1||!i.cliff)&&(s=!1),Math.abs(a)<Math.abs(o)&&(o=a)}),!0==activecharacternonindex.pc){let[a,r]=activecharacternonindex.pos;o=i.elevation-newgrid[a][r].elevation}if((this.readOpacity()>=1||s)&&null==this.character){let c=[0,0,0];for(let l=e-1;l<=e+1;l++)if(newgrid[l]){for(let d=t-1;d<=t+1;d++)if(newgrid[l][d]&&!1!==newgrid[l][d].visible&&1>newgrid[l][d].readOpacity()){let $=newgrid[l][d].light.slice();c=c.map(function(e,t){return $[t]>e?$[t]:e})}}n=c.slice()}let u=[0,0,0],h=[0,0,0],p="&nbsp";if(!0==procgendebug&&128>takeav(n)&&(n=[128,128,128]),!1!==this.visible&&(u=(n=n.map(e=>e*Math.max(this.visibility,.5))).map((e,t)=>e*this.absorbtionBase[t]),this.readOpacity()>=1&&(u=u.map(e=>e/2)),h=(u=(u=(u=u.map(e=>Math.max(0,e))).map(n=>n*noisemap[e][t])).map(e=>256*(e/256)**(1/gamma))).map(e=>Math.min(e/2,2560)),p=this.symbolBase),this.fluids.length>0&&!1!==this.visibile){let m=[1,1,1];this.fluids.forEach(function(e){if(e.symbol&&(p=e.symbol),null!==e.bgabsorbtion){let t=1;e.thickness&&(t=e.thickness);for(let n=0;n<t;n++)m=m.map((t,n)=>t*e.bgabsorbtion[n])}}),u=n.map((e,t)=>e*m[t]),h=n.map((e,t)=>e*m[t]*.5),u=(u=u.map(e=>Math.max(0,e))).map(e=>256*(e/256)**(1/gamma))}if(this.objects.length>0&&!1!==this.visible){let _=this.objects[0];_.symbol&&(p=_.symbol),this.fgOutputColor=n.slice(),u=(u=(u=n.map((e,t)=>e*_.absorbtion[t])).map(e=>Math.max(0,e))).map(e=>256*(e/256)**(1/gamma)),null!==_.bgabsorbtion&&(h=n.map((e,t)=>e*_.bgabsorbtion[t]*.5))}if(this.items.length>0&&!1!==this.visible){let f=this.items[0];p=f.symbol,u=(u=(u=n.map((e,t)=>e*f.absorbtion[t])).map(e=>Math.max(0,e))).map(e=>256*(e/256)**(1/gamma))}if(this.slope&&(p="/"),0!==o&&(o<0&&(u=u.map((e,t)=>Math.max(e*(1+.1*o),h[t]))),o>0&&(h=h.map(e=>e*(1+.2*o))),o>1&&"&#183"==p&&(p="&#149"),o<-4&&!1==this.visible&&this.los&&(p="&#183",u=[16,16,16])),null!==this.character&&!1!==this.visible){if(!0==this.character.dead)this.character=null;else{let g=this.character;if(!1!==g){let w=takeav(newgrid[e][t].light)/256;u=g.color.map(e=>Math.max(e/2,w*e)),h=h.map(e=>.75*e),p=g.symbol}}}if(this.uiElements.length>0){for(let b=0;b<this.uiElements.length;b++){let v=this.uiElements[b];"$"!=v.symbol?" "!=v.symbol&&("^"==v.symbol&&(v.symbol="&#183"),p=v.symbol,u=u.map((e,t)=>v.color[t])):(u=u.map((e,t)=>e+256*v.color[t]),h=h.map((e,t)=>e+128*v.color[t]))}this.uiElements=[]}u=u.map(e=>e*brightnessadjust),h=h.map(e=>e*brightnessadjust);let k=`<span 
            class = "clickable";
            y = ${e}
            x = ${t}
            style="
                color: rgb(${u});
                background-color: rgb(${h});
                font-size: ${fontsize}px;"
            >${p}</span>`;return k}cursorread(){let e=this,t=1;null!==this.character&&(addcharlabel(this.pos,this.character),t+=2,showdetails&&(t+=this.character.conditions.length)),this.objects.length>0&&this.objects.forEach(function(n){adduilabel(n.name,e.pos,[64,64,64],t),t++,!0==showdetails&&n instanceof Weapon&&(adduilabel(`1-${n.damagedie.toString()}+${activecharacternonindex.getatkbonus(n)}`,e.pos,[64,64,64],t),t++)}),this.fluids.length>0&&this.fluids.forEach(function(n){adduilabel(n.name,e.pos,[64,64,64],t),t++})}readOpacity(e){if(void 0!==e&&e<this.elevation)return 1;let t=this.transparancy;return null!==this.character&&lackscondition(conditions.Prone,this.character)?t=.75:this.objects.length>0&&(t=1-this.objects[0].opacity),this.fluids.length>0&&this.fluids.forEach(function(e){let n=1;e.thickness&&(n=e.thickness);for(let i=0;i<n;i++)t*=1-e.opacity}),1-t}addCharacter(e){let t=this;if(null==this.character)this.character=e,e.pos=this.pos.slice();else{e.iterations||(e.iterations=0),e.iterations++;let n=shuffle(directions),i=[];for(let s=0;s<n.length;s++){let[o,a]=n[s].map((e,n)=>e+t.pos[n]);if(!newgrid[o]||!newgrid[o][a])continue;let r=newgrid[o][a];if(r.traversable&&(i.push(r),null==r.character)){r.addCharacter(e);break}s==n.length-1&&i.length>0&&i[0].addCharacter(e)}}}addObject(e){if(e.number<=0)return;if(!(e.number>1)||e instanceof Ammunition)e.number>1?e.name=`${e.basename}(${e.number})`:e.name=e.basename;else{e.name=e.basename,e.number--,this.addObject(new e.constructor),this.addObject(e);return}if(e.iterations>20)return;let t=this,n=!0;if(this.objects.length>0&&(n=!1),n)e.iterations=0,e.pos=this.pos.slice(),this.objects.push(e),this.updateObjects(),e.initialize();else{e.iterations||(e.iterations=0),e.iterations++;let i=shuffle(directions),s=[];for(let o=0;o<i.length;o++){let[a,r]=i[o].map((e,n)=>e+t.pos[n]);if(!newgrid[a]||!newgrid[a][r])continue;let c=newgrid[a][r];if(c.traversable&&(s.push(c),0==c.objects.length)){c.addObject(e);break}o==i.length-1&&s.length>0&&s[0].addObject(e)}}}updateObjects(){let e=this;if(this.traversable=!0,this.moveCost=this.baseMoveCost,this.objects.length>0){let t=this.objects[0];!1==t.traversable&&(this.traversable=!1),this.moveCost+=t.movecost,t.pos=this.pos.slice()}this.fluids.length>0&&this.fluids.forEach(function(t){e.moveCost+=t.movecost,t.pos=e.pos.slice()})}addFluid(e){if(e.iterations>5)return;let t=this,n=!0,i=!1;if(this.fluids.forEach(function(t){t.basename==e.basename&&(n=!1,t instanceof gas&&Math.random()>.5&&t.thickness<2&&(t.addthickness(),i=!0))}),!i){if(n)e.pos=this.pos.slice(),this.fluids.push(e),this.updateObjects(),e.initialize();else{e.iterations||(e.iterations=0),e.iterations++;let s=shuffle(directions),o=[];for(let a=0;a<s.length;a++){let[r,c]=s[a].map((e,n)=>e+t.pos[n]);if(!newgrid[r]||!newgrid[r][c])continue;let l=newgrid[r][c];if(l.traversable&&l.elevation<=t.elevation&&(o.push(l),0==l.fluids.length)){l.addFluid(e);break}a==s.length-1&&o.length>0&&o[0].addFluid(e)}}}}removeFluid(e){e.destroyed=!0,this.fluids=this.fluids.filter(t=>t.basename!=e.basename)}readLightsource(){if(this.templightsources&&this.templightsources.length>0){let e=this.templightsources[0][0];return this.templightsources[0][1]--,this.templightsources[0][1]<=0&&this.templightsources.shift(),e}if(null!==this.character){let t=null,n=[this.character.primaryitem,this.character.secondaryitem,this.character.offhanditem];if(n.forEach(function(e){e.lightsources&&e.lightsources.length>0&&e.lightsources.forEach(function(e){t=e})}),t)return t}if(this.objects.length>0&&this.objects[0].lightsources.length>0)return this.objects[0].lightsources[0];if(this.fluids.length>0){for(let i=0;i<this.fluids.length;i++)if(this.fluids[i].lightsources.length>0)return this.fluids[i].lightsources[0]}}addTempSource(e,t){this.templightsources||(this.templightsources=[]),this.templightsources.push([e,t])}addvisiblecharacter(e){let t=!1;this.charactersinview.forEach(function(n){n.index==e.index&&(t=!0)}),!1==t&&this.charactersinview.push(e)}removevisiblecharacter(e){for(let t=0;t<this.charactersinview.length;t++)if(this.charactersinview[t].index==e.index){this.charactersinview.splice(t,1);break}}gethazards(){let e=[0,0];return this.objects.length>0&&this.objects.forEach(function(t){!0==t.burning&&(e[0]+=1,e[1]+=5)}),this.fluids.length>0&&this.fluids.forEach(function(t){t.choking&&(e[1]+=1,console.log("Returning a choking hazard"))}),e}}class object{constructor(e,t,n,i,s,o,a,r,c,l){this.name=e,this.symbol=t,this.absorbtion=n,this.bgabsorbtion=i||null,this.opacity=s||0,this.traversable=o,this.movecost=a||0,this.action=r||null,this.effects=c||[],this.lightsources=l||[],this.pos=[],this.ac=0,this.pc=!1,this.destructable=!0,this.durability=1,this.hp=1,this.basename=e,this.baseabsorbtion=n,this.basesymbol=t,this.burnduration=1,this.flammable=!0}damage(e){if(this.destructable&&!this.destroyed){let t=Math.floor(e/this.durability);this.hp-=t;adduilabel(t.toString(),this.pos,convertAbstoColor(this.absorbtion),1,!0,!1,!1,!1),this.hp<=0&&this.break()}}break(){let[e,t]=this.pos;newgrid[e][t].objects.shift(),this.destroyed=!0,this.remnants.forEach(function(n){n instanceof fluid?newgrid[e][t].addFluid(n):newgrid[e][t].addObject(n)}),hear(new Sound(this.pos,10,this,null,soundeffects.woodbreaking)),newgrid[e][t].updateObjects()}addRemnants(){this.remnants=[];for(let e=0;e<2;e++){let t=new object("Wreckage",randomSymbol(["/","\\"]),this.baseabsorbtion,null,0,!0,0);t.destructable=!1,this.remnants.push(t)}}initialize(){this.destructable&&this.addRemnants();for(let e=0;e<directions.length;e++){let[t,n]=directions[e].map((e,t)=>e+this.pos[t]);if(!newgrid[t]||!newgrid[t][n])continue;let i=newgrid[t][n];i.objecttriggers||(i.objecttriggers=[]),i.objecttriggers.push(this)}}react(e,t,n){!this.destroyed&&"Miss"==n.soundcontent&&1>=chebyshevDistance(n.target,this.pos)&&Math.random()>.75&&this.damage(1),!this.destroyed&&this.burning&&0==chebyshevDistance(t.pos,this.pos)&&t.damage(1)}burn(){if(this.burning||this.burnt||!this.flammable)return;this.name=`Burning ${this.basename}`,this.burning=!0,this.lightsources.push(new lightsource(this.pos,[256,128,64],[1,.5,.25],1)),this.absorbtion=materials.fire,null!=this.bgabsorbtion&&(this.bgabsorbtion=materials.fire);let[e,t]=this.pos;newgrid[e][t].character&&newgrid[e][t].character.damage(5),envobjects.push(this)}update(){if(this.burning&&!this.destroyed){let[e,t]=this.pos;null!==newgrid[e][t].character&&newgrid[e][t].character.damage(5),newgrid[e][t].addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null)),newgrid[e][t].addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null)),newgrid[e][t].addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null)),newgrid[e][t].addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null)),this.spreadfire(),this.destructable&&(this.damage(1),this.destroyed||envobjects.push(this)),this.burnduration-=1,this.burnduration>0?envobjects.push(this):(this.lightsources=[],this.burning=!1,this.burnt=!0,this.name=`charred ${this.basename}`,this.absorbtion=[0,0,0],null!=this.bgabsorbtion&&(this.bgabsorbtion=[.2,.2,.2]))}}spreadfire(){for(let e=0;e<directions.length;e++){let[t,n]=directions[e].map((e,t)=>e+this.pos[t]);if(!newgrid[t]||!newgrid[t][n])continue;let i=newgrid[t][n];i.objects.length>0&&!i.objects[0].burning&&i.objects[0].burn(),i.fluids&&i.fluids.length>0&&i.fluids.forEach(function(e){e.burning||e.burnt||e.burn()})}}}class Item extends object{constructor(e,t,n){super(e,t,n,null,0,!0),this.name=e,this.symbol=t,this.absorbtion=n||[1,1,1]}}class Weapon extends Item{constructor(e,t,n,i,s,o,a,r,c,l,d,$){super(e,t,n),this.range=s||1,this.bonus=o||0,this.damagedie=a,this.stat=r||0,this.minrange=c||0,this.drawsound=l||soundeffects.daggerdraw,this.hitsound=d||soundeffects.swordhit,this.misssound=$||soundeffects.swordswing,this.stacksize=1,this.number=1,this.durability=3,this.twohanded=!1}}class Unarmed extends Weapon{constructor(){super("Unarmed",null,null,null,1.9,0,1,0,0,null,null,null)}}class Dagger extends Weapon{constructor(e){super("Dagger","&#x2020",materials.metal,actions.Attack,3.5,0,2,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.throwable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Athame extends Weapon{constructor(e){super("Athame","&#x2020",materials.abyss,actions.Attack,3.5,0,6,1,0,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.throwable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=conditionattackpermute(conditions.Bleeding)}}class Javelin extends Weapon{constructor(e){super("Javelin","-",materials.wood,actions.Attack,3.5,0,2,0,0,soundeffects.tap,soundeffects.arrowflight),this.stacksize=3,this.throwable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Club extends Weapon{constructor(){super("Club","|",materials.wood,actions.Attack,1.9,0,2,0,null)}}class Longsword extends Weapon{constructor(){super("Longsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing)}}class Speedsword extends Weapon{constructor(){super("Speedsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let n=function(){e.character.tc[2]>0&&(e.character.tc[2]--,e.character.tc[1]++)};return e.onhiteffects.push(n),e.onmisseffects.push(n),e}}}class Shortsword extends Weapon{constructor(){super("Shortsword","/",materials.metal,actions.Attack,1.9,0,4,1,null,soundeffects.shortsworddraw)}}class Rapier extends Weapon{constructor(){super("Rapier","/",materials.metal,actions.Attack,1.9,0,1,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let n=function(){let[e,n]=t,i=newgrid[e][n].character;i&&i.drop()};return e.onhiteffects.push(n),e}}}class Katana extends Weapon{constructor(){super("Katana","/",materials.metal,actions.Attack,1.9,0,1,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=conditionattackpermute(conditions.Bleeding)}}class Punching_Red_Glove_Expanding_Arm_Kapow extends Weapon{constructor(){super("Punching Red Glove Expanding Arm Kapow","/",materials.metal,actions.Attack,1.9,0,1,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let n=function(){let[n,i]=t,s=newgrid[n][i].character,o=e.pos.slice(),a=t.map((e,t)=>o[t]-e);if(s)for(let r=0;r<1;r++){let c=s.pos.map((e,t)=>e-a[t]);s.actionqueue.push(new action("Fall",movefunc,[0,0,0],1,c,s,t)),move(s)}};return e.onhiteffects.push(n),e}}}class Battleaxe extends Weapon{constructor(){super("Battleaxe","/",materials.metal,actions.Attack,1.9,0,4,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing),this.specialeffect=function(e,t){let n=function(){directions.forEach(function(n){let[i,s]=n.map((t,n)=>t+e.pos[n]);if(1==chebyshevDistance([i,s],t)&&newgrid[i][s]&&null!==newgrid[i][s].character&&newgrid[i][s].character.pc!==e.character.pc){rangedanimate(e.pos,[i,s],convertAbstoColor(e.weapon.absorbtion));let o=e,a=newgrid[i][s].character;100*Math.random()<o.percenthitchance&&a?a.damage(randomNumber(o.damagerange[1],o.damagerange[0])):adduilabel("Miss",[i,s],[128,128,128],1,!0,!1)}})};return e.onhiteffects.push(n),e}}}class Warhammer extends Weapon{constructor(){super("Warhammer","T",materials.metal,actions.ProneAttack,1.9,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=conditionattackpermute(conditions.Prone)}}class Pike extends Weapon{constructor(){super("Pike","/",materials.metal,actions.Attack,2.5,0,4,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing)}}class Halberd extends Weapon{constructor(){super("Halberd","/",materials.metal,actions.Attack,2.5,0,4,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing);let e=this;this.specialeffect=function(t,n){let i=function(){directions.forEach(function(i){let[s,o]=i.map((e,t)=>e+n[t]);if(chebyshevDistance([s,o],t.pos)<=e.range&&newgrid[s][o]&&null!==newgrid[s][o].character&&newgrid[s][o].character.pc!==t.character.pc){rangedanimate(t.pos,[s,o],convertAbstoColor(t.weapon.absorbtion));let a=t,r=newgrid[s][o].character;100*Math.random()<a.percenthitchance&&r?r.damage(randomNumber(a.damagerange[1],a.damagerange[0])):adduilabel("Miss",[s,o],[128,128,128],1,!0,!1)}})};return t.onhiteffects.push(i),t}}}class Polehammer extends Weapon{constructor(){super("Polehammer","T",materials.metal,actions.ProneAttack,2.5,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing),this.specialeffect=conditionattackpermute(conditions.Prone)}}class Ammunition extends object{constructor(e,t,n){super(e,t,n,null,0,!0,0,null,null,null)}}class Arrow extends Ammunition{constructor(e){super("Arrow","&#x02D7",materials.wood),this.stacksize=15,this.throwable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`)}}class Longbow extends Weapon{constructor(){super("Longbow",")",materials.wood,actions.Attack,7.9,0,4,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0}}class Recurve_Bow extends Weapon{constructor(){super("Recurve Bow","}",materials.wood,actions.Attack,8.9,0,6,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.specialeffect=function(e,t){for(let n=e.modbreakdown.length-1;n>=0;n--){if("Half Cover-10"==e.modbreakdown[n]){e.modbreakdown.splice(n,1),e.extrinsmod+=2,e.percenthitchance+=10,e.avdamageac10+=.1*takeav(e.damagerange);continue}if("Three Quarters Cover-25"==e.modbreakdown[n]){e.modbreakdown.splice(n,1),e.extrinsmod+=5,e.percenthitchance+=25,e.avdamageac10+=.25*takeav(e.damagerange);continue}}e.percenthitchance=Math.min(e.percenthitchance,100);let i=function(){let n=bresenhamLine(e.pos,t),i=n.map(e=>newgrid[e[0]][e[1]]);i.forEach(function(t){if(t.character&&t.character.pc!==e.character.pc){let n=e,i=t.character;100*Math.random()<n.percenthitchance&&i?i.damage(randomNumber(n.damagerange[1],n.damagerange[0])):adduilabel("Miss",t.pos,[128,128,128],1,!0,!1)}})};return e.onhiteffects.push(i),e.onmisseffects.push(i),e}}}class Double_Recurve_Bow extends Weapon{constructor(){super("Recurve Bow","}",materials.wood,actions.Attack,8.9,0,8,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0,this.specialeffect=function(e,t){for(let n=e.modbreakdown.length-1;n>=0;n--){if("Half Cover-10"==e.modbreakdown[n]){e.modbreakdown.splice(n,1),e.extrinsmod+=2,e.percenthitchance+=10,e.avdamageac10+=.1*takeav(e.damagerange);continue}if("Three Quarters Cover-25"==e.modbreakdown[n]){e.modbreakdown.splice(n,1),e.extrinsmod+=5,e.percenthitchance+=25,e.avdamageac10+=.25*takeav(e.damagerange);continue}}e.percenthitchance=Math.min(e.percenthitchance,100);let i=function(){let n=bresenhamLine(e.pos,t),i=n.map(e=>newgrid[e[0]][e[1]]);i.forEach(function(t){if(t.character&&t.character.pc!==e.character.pc){let n=e,i=t.character;100*Math.random()<n.percenthitchance&&i?i.damage(randomNumber(n.damagerange[1],n.damagerange[0])):adduilabel("Miss",t.pos,[128,128,128],1,!0,!1)}})},s=function(){let n=new Attack("Attack",attackfunc,[0,0,0,1],e.character.getrange(e.weapon),t,e.character,e.pos);e.character.actionqueue.push(n)};return e.onhiteffects.push(i),e.onmisseffects.push(i),e.onhiteffects.push(s),e.onmisseffects.push(s),e}}}class Shortbow extends Weapon{constructor(){super("Shortbow",")",materials.wood,actions.Attack,6.9,0,2,1,1.9,soundeffects.bowdraw),this.ammotype="Arrow",this.ammoconstructor=Arrow,this.twohanded=!0}}class Bolas extends Weapon{constructor(e){super("Bolas","&#x2020",materials.metal,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){let[n,i]=t,s=function(){addconditiondynamic(conditions.Prone,!0,newgrid[n][i].character)()};return e.onhiteffects.push(s),e.onmisseffects.push(s),e.damagerange=[1,1],e.modbreakdown=[],e}}}class OilFlask extends Weapon{constructor(e){super("Oil Flask","&#x2020",materials.metal,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){1==e.errors.length&&"No Target"==e.errors[0]&&(e.errors=[]);let[n,i]=t,s=function(){newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].addFluid(new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null)),newgrid[n][i].fluids.forEach(e=>e.burn())};return e.onhiteffects.push(s),e.onmisseffects.push(s),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class FlashPowder extends Weapon{constructor(e){super("Flash Powder","&#x2020",materials.metal,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`),this.specialeffect=function(e,t){1==e.errors.length&&"No Target"==e.errors[0]&&(e.errors=[]);let[n,i]=t,s=function(){for(let e=1;e<10;e+=2)newgrid[n][i].addTempSource(new lightsource(this.pos,[256,256,256,],[e,.6*e,.4*e],3),1);for(let t=10;t>1;t-=2)newgrid[n][i].addTempSource(new lightsource(this.pos,[256,256,256,],[t,.6*t,.4*t],3),1);drawGrid(!0),updatetraitspassive()};return e.onhiteffects.push(s),e.onmisseffects.push(s),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class Grenade extends Weapon{constructor(e){super("Grenade","&#x2020",materials.metal,actions.Attack,5.5,0,1,1,null,soundeffects.daggerdraw,soundeffects.puncture),this.stacksize=3,this.consumable=!0,this.number=e||1,e>1&&(this.name=`${this.basename}(${this.number})`);let t=this;this.specialeffect=function(e,n){1==e.errors.length&&"No Target"==e.errors[0]&&(e.errors=[]);let[i,s]=n,o=function(){[...directions,[0,0]].forEach(function(e){let[i,s]=e.map((e,t)=>e+n[t]),o=newgrid[i][s],a=o.character;o.objects.length>0&&o.objects.forEach(e=>e.damage(10)),rangedanimate(n,[i,s],convertAbstoColor(t.absorbtion)),a&&!0!==a.dead&&a.damage(10),o.addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null))}),adduilabel("*",n,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)};return e.onhiteffects.push(o),e.onmisseffects.push(o),e.damagerange=[0,0],e.percenthitchance=100,e.intrinsmod=0,e.extrinsmod=0,e.modbreakdown=[],e}}}class bonfire extends object{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}initialize(){super.initialize(),this.burn(),this.action=["Rest",restfunc,[0,0,0],1.9]}burn(){super.burn(),this.name=this.basename}update(){let[e,t]=this.pos,n=newgrid[e][t];Math.random()>.8&&n.addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null)),envobjects.push(this)}extinguish(){this.lightsources=[],this.burning=!1,this.absorbtion=[.2,.2,.2],this.name="ash"}}class corpse extends object{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}initialize(){super.initialize(),envobjects.push(this),newgrid[this.pos[0]][this.pos[1]].addFluid(new blood("Blood","",[0,0,0],materials.blood,0,!0,0))}update(){super.update();let[e,t]=this.pos;newgrid[e][t],Math.random()>.5&&newgrid[e][t].addFluid(new blood("Blood","",[0,0,0],[.5,.1,.1],0,!0,0)),Math.random()>.25&&envobjects.push(this)}}class explodingBarrel extends object{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}break(){super.break(),this.explode()}explode(){let e=this,[t,n]=this.pos;for(let i=1;i<10;i+=2)newgrid[t][n].addTempSource(new lightsource(this.pos,[256,256,256,],[i,.6*i,.4*i],3),1);for(let s=10;s>1;s-=2)newgrid[t][n].addTempSource(new lightsource(this.pos,[256,256,256,],[s,.6*s,.4*s],3),1);drawGrid(!0),updatetraitspassive(),directions.forEach(function(t){let[n,i]=t.map((t,n)=>t+e.pos[n]),s=newgrid[n][i],o=s.character;s.objects.length>0&&s.objects.forEach(e=>e.damage(10)),rangedanimate(e.pos,[n,i],convertAbstoColor(e.absorbtion)),o&&!0!==o.dead&&o.damage(10)}),adduilabel("*",e.pos,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)}}class door extends object{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d),Math.random()>.6?this.locked=!0:this.locked=!1,this.durability=2,this.hp=2}open(){if(this.locked)return!1;this.action=null,this.opacity=0,this.traversable=!0,this.movecost=0,this.symbol="/"}}class wolfCage extends object{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}break(){this.freeWolf(),super.break()}freeWolf(){let[e,t]=this.pos;newgrid[e][t].addCharacter(new Wolf([e,t]))}}class spikeTrap extends object{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}react(e,t,n){if(super.react(e,t,n),!0!==this.destroyed){let[i,s]=this.pos,o=newgrid[i][s].character;null!==o&&(o.damage(1),this.break())}}}class Light extends Item{constructor(e,t,n){super(e,t,n)}}class oilLamp extends Light{constructor(){super("Oil Lamp","&#9827",materials.metal),this.lightsources.push(new lightsource(null,[256,256,256],[1,.5,.25],1))}break(){super.break(),this.setFire()}addRemnants(){super.addRemnants();let[e,t]=this.pos;newgrid[e][t];for(let n=0;n<1;n++){let i=new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null);i.destructable=!1,i.burnduration=5,this.remnants.push(i)}}setFire(){let[e,t]=this.pos,n=newgrid[e][t];n.fluids.forEach(e=>e.burn())}explode(){let e=this,[t,n]=this.pos;for(let i=1;i<10;i+=2)newgrid[t][n].addTempSource(new lightsource(this.pos,[256,256,256,],[i,.6*i,.4*i],3),1);for(let s=10;s>1;s-=2)newgrid[t][n].addTempSource(new lightsource(this.pos,[256,256,256,],[s,.6*s,.4*s],3),1);drawGrid(!0),updatetraitspassive(),directions.forEach(function(t){let[n,i]=t.map((t,n)=>t+e.pos[n]),s=newgrid[n][i],o=s.character;s.objects.length>0&&s.objects.forEach(e=>e.damage(10)),rangedanimate(e.pos,[n,i],convertAbstoColor(e.absorbtion)),o&&!0!==o.dead&&o.damage(10)}),adduilabel("*",e.pos,convertAbstoColor(materials.fire),0,!0,!1,!1,!1,1)}initialize(){super.initialize()}}class Torch extends Light{constructor(){super("Torch","|",materials.wood),this.lightsources.push(new lightsource([0,0],[256,256,256],[5,3,2],2))}initialize(){super.initialize()}}class Sarcophagus extends object{constructor(){super("Sarcophagus","I",materials.stone,null,.5,!1)}break(){let[e,t]=this.pos,n;n=Math.random()>.66?.5>Math.random()?.5>Math.random()?new Longsword:new Battleaxe:new Halberd:Math.random()>.5?.5>Math.random()?new Shortsword:new Athame:Math.random<.5?new Longbow:new Recurve_Bow,newgrid[e][t].addObject(n),super.break()}}class oilBarrel extends object{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}addRemnants(){super.addRemnants();let[e,t]=this.pos;newgrid[e][t];for(let n=0;n<10;n++){let i=new oil("oil","",[.75,.75,.75],[.2,.2,.2],0,!0,1,null,null,null);i.destructable=!1,i.burnduration=5,this.remnants.push(i)}}}class fluid extends object{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}}class liquid extends fluid{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}}class oil extends liquid{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d)}burn(){this.burning||this.burnt||(super.burn(),this.spreadfire())}}class Water extends liquid{constructor(){super("Water","~",materials.water,materials.water,0,!0,1,null,null),this.flammable=!1}}class blood extends liquid{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d),this.destructable=!1,this.flammable=!1}}class gas extends fluid{constructor(e,t,n,i,s,o,a,r,c,l,d){super(e,t,n,i,s,o,a,r,c,l,d),this.thickness=1}addthickness(){this.thickness++,this.thickness>1&&(this.name=`Thick ${this.basename}`)}removeThickness(){if(!this.destroyed){if(this.thickness--,this.thickness<1){let[e,t]=this.pos,n=newgrid[e][t];n.removeFluid(this)}this.thickness<2&&(this.name=this.basename)}}}class smoke extends gas{constructor(){super("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null),this.flammable=!1}update(){if(super.update(),Math.random()>.75&&this.removeThickness(),!0!==this.destroyed&&envobjects.push(this),this.thickness>1){this.choking=!0;let[e,t]=this.pos,n=newgrid[e][t],i=n.character;i&&i.damage(1),Math.random()>.5&&(this.removeThickness(),newgrid[e][t].addFluid(new smoke("Smoke","",[.1,.1,.1],[.5,.5,.5],.1,!0,0,null,null,null)))}else this.choking=!1}initialize(){super.initialize(),envobjects.push(this)}removeThickness(){super.removeThickness(),this.thickness<2&&(this.choking=!1)}}class Roomtype{constructor(e,t,n,i,s){this.roomname=e,this.roomsize=t,this.roomshape=n,this.objects=i,this.enemies=s}}class AttackRoll{constructor(e,t,n,i){this.character=e,this.weapon=i,i||(i=e.primaryitem);let[s,o]=t,a=0,r=e.getatkbonus(i),c=[],l=[],d=newgrid[s][o].character,$=!1;(null==d||d.pc==e.pc)&&(d=newgrid[s][o].objects[0],$=!0);let u=dist(n,t);if(i.ammotype&&!e.ammunition[i.ammotype]&&l.push(`No ${i.ammotype}s`),i.twohanded&&e.offhanditem&&e.offhanditem.basename!==e.unarmed.basename?l.push("Need two free hands"):!1===drawline(n,t)?l.push("Something in the way"):e.getrange(i)<u?l.push("Out of range"):null==d&&l.push("No Target"),0===l.length&&d){let h=[s,o].map((e,t)=>e-(n[t]-e)),p=newgrid[h[0]][h[1]];1===chebyshevDistance(n,[s,o])&&p&&p.character&&p.character.pc==e.pc&&p.character!==e&&(c.push("Flanked+10"),a+=2),!1!=d.pc||d.visiblecharacters&&d.visiblecharacters[e.index]||(c.push("Unaware+50"),a+=10),!0==d.pc&&!1==newgrid[n[0]][n[1]].visible&&(c.push("Unaware+50"),a+=10);let m=drawline(n,t);i.range>1.9&&m>0&&(m>=.5?(c.push("Three Quarters Cover-25"),a-=5):(c.push("Half Cover-10"),a-=2)),newgrid[s][o].lightlevel<2&&(c.push("Dim Light-10"),a-=2),dist(n,t)<i.minrange&&(c.push("Too Close-25"),a-=5),!1==lackscondition(conditions.Stunned,d)&&(c.push("Stunned+25"),a+=5),!1==lackscondition(conditions.Prone,d)&&(c.push("Prone+25"),a+=5),!1==lackscondition(conditions.Surprised,d)&&(c.push("Surprised+10"),a+=2);let _=newgrid[n[0]][n[1]],f=newgrid[s][o],g=_.elevation-f.elevation;g>0&&(c.push("High Ground+10"),a+=2),g<0&&(c.push("Low Ground-10"),a-=2)}let w;d&&(w=d.ac);let b=Math.min((1-(w-(r+a))/20)*100,100),v=e.getavdamage(i),k=takeav(v)*(10+(r+a))/20;if(this.pos=n,this.percenthitchance=b,this.damagerange=v,this.avdamageac10=k,this.intrinsmod=r,this.extrinsmod=a,this.defenderac=w,this.modbreakdown=c,this.errors=l,this.onhiteffects=[],i.onhiteffects&&(this.onhiteffects=i.onhiteffects.slice()),this.onmisseffects=[],i.onmisseffects&&(this.onmisseffects=i.onmisseffects.slice()),!0==i.throwable&&u>1.9){let z=()=>e.removeItem(i);this.onhiteffects.push(z),this.onmisseffects.push(z);let E=()=>newgrid[s][o].addObject(new i.constructor);this.onhiteffects.push(E),this.onmisseffects.push(E)}if(!0==i.consumable){let A=()=>e.removeItem(i);this.onhiteffects.push(A),this.onmisseffects.push(A)}if(i.ammotype){let C=[()=>e.removeAmmo(i.ammotype)];this.onhiteffects.push(...C),this.onmisseffects.push(...C)}}}class Sound{constructor(e,t,n,i,s){this.pos=e,this.volume=t,this.origin=n,this.content=i||null,this.soundeffect=s}}class Dwarf extends enemy{constructor(e){super(e,"Dwarf",[0,0,0],1,[5,1,1],!1,"D",[128,128,128],100,[],[],[],null),this.states=[new State("idle",defaultdwarf,null,[0,1]),new State("hostile",defaultdwarf,null,[0,1]),new State("hunting",defaultdwarf,null,[0,1]),new State("fleeing",defaultdwarf,null,[0,1]),],this.reactions=[],this.actions=[moveusecase,digusecase]}}function updatecharacters(){characters=[...playercs,...nonpcs]}function updatecharactershere(){nonpcshere=[],objectshere=[];for(let e=viewportpos[0]-dontcaredistance;e<=viewportpos[0]+dontcaredistance;e++)for(let t=viewportpos[1]-dontcaredistance;t<=viewportpos[1]+dontcaredistance;t++){if(e<0||e>=mapsizey||t<0||t>=mapsizex)continue;null!==newgrid[e][t].character&&!0!==newgrid[e][t].character.pc&&nonpcshere.push(newgrid[e][t].character);let n=newgrid[e][t].objects;for(let i=0;i<n.length;i++){let s=n[i];objectshere.push(s)}}}function lightcheck(e,t){return function(){let[n,i]=this.character.pos;return!0==e?newgrid[n][i].lightlevel>=t:newgrid[n][i].lightlevel<=t}}function hostileallycheck(){let[e,t]=this.character.pos;for(let n=0;n<nonpcshere.length;n++){let i=nonpcshere[n];if("idle"!==i.state&&!1!==drawline([e,t],i.pos)&&(e!==i.pos[0]||t!==i.pos[1]))return this.character.target=i.target,console.log(`${this.character.target} is the new target of this character, it should be the same as ${i.target}`),!0}}function hostilecheck(){}function friendlyadjacent(){[y,x]=this.character.pos;for(let e=y-1;e<=y+1;e++)for(let t=x-1;t<=x+1;t++)if(null!==newgrid[e][t].character&&(e!=y||t!=x)&&newgrid[e][t].name==this.character.name)return!0;return!1}function addcondition(e,t){return function(){let n=new condition(e.name,e.starteffect,e.turneffect,e.duration,e.resistance,e.endeffect,this.character);!0==lacksresistance(n,this.character)&&!0==lackscondition(n,this.character)&&(this.character.conditions.push(n),this.character.conditions[this.character.conditions.length-1].starteffect(),t&&adduilabel(n.name,n.character.pos,[128,128,0],1,!0),!0==n.resistance&&this.character.condresists.push(n.name),updateGrid())}}function addconditiondynamic(e,t,n){return function(){if(!(n instanceof character))return;let i=new condition(e.name,e.starteffect,e.turneffect,e.duration,e.resistance,e.endeffect,n);!0==lacksresistance(i,n)&&!0==lackscondition(i,n)&&(n.conditions.push(i),n.conditions[n.conditions.length-1].starteffect(),t&&adduilabel(i.name,i.character.pos,i.character.color,1,!0,!1,!1),!0==i.resistance&&n.condresists.push(i.name))}}function lacksresistance(e,t){for(let n of t.condresists)if(n==e.name)return!1;return!0}function lackscondition(e,t){if(!t.conditions)return!0;for(let n of t.conditions)if(n.name==e.name)return!1;return!0}function skipturn(){let[e,t]=this.character.pos;adduilabel("!",[e,t],[128,128,0],0,!0,!1,!1),this.character.tc=[0,0,0]}function skipturnandyelp(){let[e,t]=this.character.pos;if(adduilabel("!",[e,t],[128,128,0],0,!0,!1,!1),!0!==this.character.pc){let n=new action("Huh?",chatfunc,[0,0,1],0,this.character.pos,this.character,this.character.pos,null,soundeffects.goblinyelp);n.loudness=15,this.character.actionqueue.push(n),move(this.character)}this.character.tc=[0,0,0]}function losemove(){let[e,t]=this.character.pos;adduilabel("+",[e,t],[128,128,0],0,!0,!1,!1),this.character.tc[0]=0,this.character.tc[2]=0,this.character.actionqueue=[]}function takedamage(e=1){return function(){this.character.damage(e)}}function damagebonus(e){return function(){this.character.damagebonus+=e,console.log(`damage bonus of ${this.character.damagebonus}`)}}function tohitbonus(e){return function(){this.character.tohitbonus+=e}}function becomehostile(){let e=null;for(let t=0;t<playercs.length;t++)!1!==drawline(this.character.pos,playercs[t].pos)&&!1==playercs[t].dead&&(null==e?e=playercs[t]:dist(this.character.pos,playercs[t].pos)<dist(this.character.pos,e.pos)&&(e=playercs[t]));null!=e&&(this.character.target=e.pos.slice(),this.character.state,this.character.state)}function becomehostilelowesthp(){let e=null;for(let t=0;t<playercs.length;t++)!1!==drawline(this.character.pos,playercs[t].pos)&&!1==playercs[t].dead&&(null==e?e=playercs[t]:playercs[t].hp<e.hp&&(e=playercs[t]));null!=e&&(this.character.target=e.pos.slice(),this.character.state,"agro"!=this.character.state&&(this.character.state="agro"))}function movefunc(){let e=this.character,t=newgrid[e.pos[0]][e.pos[1]],[n,i]=this.target;if(!(!1!==newgrid[n][i].traversable&&null==newgrid[n][i].character&&1>=Math.abs(newgrid[n][i].elevation-t.elevation)))return e.actionqueue=[],!1;newgrid[e.pos[0]][e.pos[1]].character=null,e.pos=[n,i],newgrid[n][i].character=this.character,removecondition(e,"Prone")}function endturnfunc(){this.character.tc[0]=0,this.character.tc[1]=0}function digfunc(){let[e,t]=this.target;newgrid[e][t]=new Tile(...tiletypes.RoughStoneFloor,[e,t]),Math.random()>.95&&newgrid[e][t].addCharacter(new Dwarf([e,t]))}function chatfunc(){}function switchweapon(){char=this.character;let e=char.primaryitem;char.primaryitem=char.secondaryitem,char.secondaryitem=e,adduilabel(char.primaryitem.name,char.pos,char.color,1,!0,!1),char.primaryitem.drawsound&&(this.soundeffect=char.primaryitem.drawsound),this.loudness=1}function getfunc(){char=this.character;let e=newgrid[char.pos[0]][char.pos[1]].objects.shift();e.drawsound&&(this.soundeffect=e.drawsound),char.addItem(e)}function leavefunc(){let e=this.character;e.drop()}function leavefuncoffhand(){let e=this.character;e.dropoffhand()}function darkattackpermute(e){let t=e;for(let n=0;n<e.modbreakdown.length;n++)"Dim Light-10"==e.modbreakdown[n]&&(t.extrinsmod+=4,t.percenthitchance+=20,e.modbreakdown[n]="Dim Light+10",t.avdamageac10=takeav(t.damagerange)*((10+(t.intrinsmod+t.extrinsmod))/20));return t}function attackfunc(e=!1,t=null){t||(t=this.character.primaryitem);let n=e=>e;null!=this.character.specialattack&&(n=this.character.specialattack);let i=n(new AttackRoll(this.character,this.target,this.pos,t),this.target);if(null!=t.specialeffect&&(i=t.specialeffect(i,this.target)),!0==e)return i;let[s,o]=this.target,a=newgrid[s][o].character;if(a&&a.pc!=this.character.pc||(a=newgrid[s][o].objects[0]),0!==i.errors.length&&!1==e){for(let r=0;r<i.errors.length;r++)adduilabel(i.errors[r],this.character.pos,[128,128,128],r+1,!0,!1,!1,!1);return this.character.actionqueue=[],!1}if(0===i.errors.length&&!1==e){if(rangedanimate(this.character.pos,this.target,convertAbstoColor(t.absorbtion)),100*Math.random()<i.percenthitchance&&a){for(let c=0;c<i.onhiteffects.length;c++)i.onhiteffects[c]();a.damage(damage=randomNumber(i.damagerange[1],i.damagerange[0])),t.hitsound&&(this.soundeffect=t.hitsound),this.soundcontent="Attack"}else{adduilabel("Miss",this.target,[128,128,128],1,!0,!1),this.soundcontent="Miss",t.misssound&&(this.soundeffect=t.misssound);for(let l=0;l<i.onmisseffects.length;l++)i.onmisseffects[l]()}if(i.modbreakdown.length)for(let d=0;d<i.modbreakdown.length;d++){let $=i.modbreakdown[d],u=[128,128,128];for(let h=0;h<$.length;h++)"+"==$.charAt(h)&&(u=[0,64,0]),"-"==$.charAt(h)&&(u=[64,0,0]);adduilabel($,[s,o],u,d+2,!0,!1)}}}function sneakattackpermute(e){return 1!==e.weapon.stat?(e.modbreakdown.push("Sneak attack requires finnesse weapon"),e):!0!==e.weapon.throwable&&e.weapon.range>1.9?(e.modbreakdown.push("Sneak attack requires melee or thrown weapon"),e):e.character.offhanditem&&e.character.offhanditem.basename!==e.character.unarmed.basename?(e.modbreakdown.push("Sneak attack requires free offhand"),e):(e.damagerange=e.damagerange.map(t=>t+Math.max(0,e.extrinsmod)),e.extrinsmod>0&&e.modbreakdown.push(`Sneak Attack+${e.extrinsmod}dmg`),e)}function sharpshooterpermute(e){return!(e.weapon.range>1.9)||e.weapon.throwable||e.modbreakdown.some(e=>"Half Cover-10"==e||"Three Quarters Cover-25"==e)||(e.extrinsmod+=3,e.damagerange=e.damagerange.map(e=>e+2),e.modbreakdown.push("Clear Shot+15")),e}function rangedanimate([e,t],[n,i],s){let o=linecharacter([e,t],[n,i]),a=bresenhamLine([e,t],[n,i]);a.shift(),addanimation(a,[o],s)}function linecharacter([e,t],[n,i]){let s=Math.abs(t-i),o=Math.abs(e-n);return symbol=s>2*o?"-":o>2*s?"|":Math.sign(t-i)==Math.sign(e-n)?"\\":"/"}function linecharacterdiagonalpreference([e,t],[n,i]){let s=Math.abs(t-i),o=Math.abs(e-n);return symbol=s==2*o?"-":o==2*s?"|":Math.sign(t-i)==Math.sign(e-n)?"\\":"/"}function conditionattackpermute(e){return function(t,[n,i]){return(target=newgrid[n][i].character)&&t.onhiteffects.push(addconditiondynamic(e,!0,target)),t}}function cleaveattack(){}function grenadeattack(){let[e,t]=this.target,n=Math.floor(1);for(let i=e-n;i<=e+n;i++)for(let s=t-n;s<=t+n;s++)null!==newgrid[i][s].character&&newgrid[i][s].character.pc!==this.character.pc&&newgrid[i][s].character.damage(10)}function restfunc(){let e=this.character,[t,n]=e.pos;!0===e.pc&&(addconditiondynamic(conditions.Resting,!0,e)(),restcheck(),!0==e.pc&&(e.actionqueue=[],playerendturn()))}function dashfunc(){let e=this.character;e.tc[0]+=e.tcmax[0];let[t,n]=e.pos;adduilabel("Dash",e.pos,e.color,1,!0)}function standgroundfunc(){let e=this.character;e.tc[1]+=e.tcmax[1];let[t,n]=e.pos;adduilabel("Stand Ground",e.pos,e.color,1,!0)}function oldattackofop(){let e=this.character,[t,n]=e.pos;for(let i=t-1;i<=t+1;i++)for(let s=n-1;s<=n+1;s++){if(!newgrid[t]||!newgrid[t][n])continue;let o=newgrid[i][s].character;if(null!==o&&o.actionqueue[0]&&"Move"==o.actionqueue[0].name&&o.pc!==e.pc){if(dist(e.pos,o.actionqueue[0].target)>1.8){let a=actions.Attack,r=new Attack(...a,e.getrange(),o.pos,e,e.pos);r.cost=[0,0,1],canAffordAction(r,e)&&(e.actionqueue.push(r),e.actionqueue.shift().func())}}else if(o&&o.actionqueue[0]&&"Attack"==o.actionqueue[0].name&&o.pc!==e.pc&&dist(o.pos,o.actionqueue[0].target)>1.8){let c=actions.Attack,l=new Attack(...c,e.getrange(),o.pos,e,e.pos);l.cost=[0,0,1],canAffordAction(l,e)&&(e.actionqueue.push(l),move(e))}}}function checkforaoomove([e,t],[n,i],s){for(let o=e-1;o<=e+1;o++)for(let a=t-1;a<=t+1;a++)if(newgrid[o][a]&&newgrid[o][a].character&&newgrid[o][a].character.pc!==s.pc&&dist([n,i],[o,a])>1.8&&newgrid[o][a].character.tc[2]>0)return!0;return!1}function checkforaooattack([e,t],[n,i],s){for(let o=e-1;o<=e+1;o++)for(let a=t-1;a<=t+1;a++)if(newgrid[o][a]&&newgrid[o][a].character&&newgrid[o][a].character.pc!==s.pc&&dist([e,t],[n,i])>1.8&&newgrid[o][a].character.tc[2]>0)return!0;return!1}function startoverwatch(){let e=this.character;if(e.tc[2]<1)return!1;addconditiondynamic(conditions.Overwatch,!0,e)(),this.soundeffect=this.character.primaryitem.drawsound,!0==e.pc&&playerendturn()}function oldoverwatch(){let e=this.character,[t,n]=e.pos,i=e.getrange(),s=Math.floor(i);for(let o=t-s;o<=t+s;o++)if(!(o<0)&&!(o>=mapsizey))for(let a=n-s;a<=n+s;a++){if(a<0||a>=mapsizex)continue;let r=newgrid[o][a].character;if(null!==r&&r.pc!==e.pc&&dist(e.pos,r.pos)<=i&&!1!==drawline(e.pos,r.pos)&&(!1==e.pc||!0==newgrid[o][a].visible)){let c=actions.Attack,l=new Attack(...c,e.getrange(),r.pos,e,e.pos);l.cost=[0,0,1],canAffordAction(l,e)&&(e.actionqueue.push(l),move(e)),removecondition(e,"Overwatch")}}}function overwatch(e,t,n,i=!1){if(lackscondition(conditions.Overwatch,e)||activecharacternonindex.pc==e.pc)return;let s=e,[o,a]=s.pos,r=s.getrange(),c=Math.floor(r);for(let l=o-c;l<=o+c;l++)if(!(l<0)&&!(l>=mapsizey))for(let d=a-c;d<=a+c;d++){if(d<0||d>=mapsizex)continue;let $=newgrid[l][d].character;if(null!==$&&$.pc!==s.pc&&dist(s.pos,$.pos)<=r&&!1!==drawline(s.pos,$.pos)&&(!1==s.pc||!0==newgrid[l][d].visible)){if(i)return!1;let u=actions.Attack,h=new Attack(...u,s.getrange(),$.pos,s,s.pos);h.cost=[0,0,1],canAffordAction(h,s)&&(s.actionqueue.push(h),move(s)),removecondition(s,"Overwatch")}}}function removecondition(e,t){for(let n=e.conditions.length-1;n>=0;n--)e.conditions[n].name==t&&e.conditions.splice(n,1)}function damageoncontact(){}function open(){let[e,t]=this.target,n=newgrid[e][t].objects[0];if(n.open){if(!1===n.open())return adduilabel("Locked",this.character.pos,this.character.color,1,!0,!1),!1;adduilabel("Open",this.character.pos,this.character.color,1,!0,!1),newgrid[e][t].updateObjects()}}function canAffordAction(e,t){return!t.tc.some((t,n)=>t<e.cost[n])}function burn(){let e=this.character;e.damage(1)}function objectburn(e){let[t,n]=e.pos,i=newgrid[t][n].character;null!==i&&addconditiondynamic(conditions.Burning,!0,i)()}function generatehuntmap(e,t,n=5){class i{constructor(e,t,n){this.pos=e.slice(),this.parent=t,this.utility=n}}let[s,o]=e,a=new PriorityQueue((e,t)=>t.utility-e.utility);a.enqueue(new i([s,o],null,10));let r={},c=0,l=0;for(;!a.isEmpty()&&l<5e3;){l++;let d=a.dequeue();c=Math.abs(d.utility-10);let $=d.pos,[u,h]=$;r[u]||(r[u]={}),!r[u][h]&&(r[u][h]=d.utility,directions.forEach(function(n){let s=$.map((e,t)=>e+n[t]);if(newgrid[s[0]]&&newgrid[s[0]][s[1]]){let o=newgrid[s[0]][s[1]],c=o.moveCost;t.knowntiles[`${s[0]},${s[1]}`]&&(t.knowntiles[`${s[0]},${s[1]}`],chebyshevDistance(s,e)>1&&(c+=100)),!0==o.traversable?a.enqueue(new i(o.pos,d,d.utility-c)):(r[s[0]]||(r[s[0]]={}),r[s[0]][s[1]]||(r[s[0]][s[1]]=-100))}else r[s[0]]||(r[s[0]]={}),r[s[0]][s[1]]||(r[s[0]][s[1]]=-100)}))}return r}function generatefleemap(e,t,n){class i{constructor(e,t,n){this.pos=e.slice(),this.parent=t,this.distance=n}}let s=new PriorityQueue((e,t)=>e.distance-t.distance);Object.values(e).forEach(function(e){let t=new i(e.lastseen,null,0);s.enqueue(t)});let o={};for(;!s.isEmpty()&&!((thisnode=s.dequeue()).distance>n);){let a=thisnode.pos,[r,c]=a;void 0===o[`${r},${c}`]&&(directions.forEach(function(e){let t=a.map((t,n)=>t+e[n]);if(newgrid[t[0]]&&newgrid[t[0]][t[1]]){let n=newgrid[t[0]][t[1]];!0==n.traversable&&void 0===o[`${t[0]},${t[1]}`]&&s.enqueue(new i(t,thisnode,thisnode.distance+n.moveCost))}}),o[`${r},${c}`]=thisnode.distance)}return o}function moveusecase(e,t,n){let i=e.tc[0];e.tc[1];let s=[],[o,a]=e.pos;if(i>0){for(let r=o-1;r<=o+1;r++)if(newgrid[r])for(let c=a-1;c<=a+1;c++){if(c==a&&r==o||!newgrid[r]||!newgrid[r][c]||null!==newgrid[r][c].character)continue;let l=newgrid[o][a].elevation-newgrid[r][c].elevation;if(Math.abs(l)>1)continue;if(!0!==newgrid[r][c].traversable){if(newgrid[r][c].objects.length>0&&null!=newgrid[r][c].objects[0].action){let d=newgrid[r][c].objects[0],$=d.action,u=new action(...$,[r,c],t,e.pos);if("Open"==u.name&&!d.locked){let h=new ActionNode(e.pos,u,e.tc.slice(),e.hazards,e.damagepotential,e,n),p=new Move("Move",movefunc,[1,0,0],null,[r,c],t,e.pos),m=subtractcost(p,e.tc),_=p.warnings.length;if(m.some(e=>e<0,m))continue;s.push(new ActionNode([r,c],p,m,e.hazards+_,e.damagepotential,h,n))}}continue}let f=new Move("Move",movefunc,[1,0,0],null,[r,c],t,e.pos),g=subtractcost(f,e.tc),w=f.warnings.length;!g.some(e=>e<0,g)&&s.push(new ActionNode([r,c],f,g,e.hazards+w,e.damagepotential,e,n))}}return s}function digusecase(e,t,n){e.tc[0],e.tc[1];let i=[],[s,o]=e.pos;for(let a=0;a<directions.length;a++){let[r,c]=e.pos.map((e,t)=>e+directions[a][t]);if(newgrid[r]&&newgrid[r][c]&&!1==newgrid[r][c].traversable){let l=new action("Dig",digfunc,[0,1,0,0],1.9,[r,c],t,[s,o]),d=subtractcost(l,e.tc),$=new ActionNode([s,o],l,d,[],0,e,n);i.push($)}}return i}function stompusecase(e,t,n){let i=e.tc[0];e.tc[1];let s=[],[o,a]=e.pos;if(i>0){for(let r=o-1;r<=o+1;r++)if(newgrid[r])for(let c=a-1;c<=a+1;c++){if(!newgrid[r][c]||!0!==newgrid[r][c].traversable||null!==newgrid[r][c].character||c==a&&r==o)continue;let l=new Move("Move",movefunc,[1,0,0],null,[r,c],t,e.pos);l.loudness=20;let d=subtractcost(l,e.tc),$=l.warnings.length;!d.some(e=>e<0,d)&&s.push(new ActionNode([r,c],l,d,e.hazards+$,e.damagepotential,e,n))}}return s}function alertusecase(e,t,n){e.tc[0];let i=e.tc[1],s=[],[o,a]=e.pos,r=new action("Alert",chatfunc,[0,1,0],0,e.pos,t,e.pos,[]);r.loudness=20;let c=new ActionNode(e.pos,r,subtractcost(r,e.tc),e.hazards,e.damagepotential,e,n);return i>=1&&s.push(c),s}function chatusecase(e,t,n){e.tc[0];let i=e.tc[1],s=[],[o,a]=e.pos,r=new action("Chat",chatfunc,[0,1,0],0,e.pos,t,e.pos,[],soundeffects.goblinchat);r.loudness=20;let c=new ActionNode(e.pos,r,subtractcost(r,e.tc),e.hazards,e.damagepotential,e,n);return i>=1&&s.push(c),s}function attackusecase(e,t,n){e.tc[0];let i=e.tc[1],s=e.activeweapon,o=[],[a,r]=e.pos;if(i<1||!t.knownenemies||0==t.knownenemies.length)return o;if(t.knownenemies.forEach(function(i){let a=i.character,r=i.lastseen;if(!1!==drawline(e.pos,r)&&!1==a.dead&&dist(e.pos,r)<t.getrange(s)){let c=new Attack("Attack",attackfunc,[0,1,0],t.getrange(s),r,t,e.pos),l=c.func(!0,e.activeweapon),d=subtractcost(c,e.tc),$=c.warnings.length;l.errors.length,o.push(new ActionNode(e.pos,c,d,e.hazards+$,e.damagepotential+l.avdamageac10,e,n))}}),t.secondaryitem){let c=new action("Switch Weapon",switchweapon,[0,0,0],0,e.pos,t,e.pos),l=new ActionNode(e.pos,c,e.tc.slice(),e.hazards,e.damagepotential,e,e.parentutility,t.secondaryitem);for(let d=0;d<playercs.length;d++)if(!1!==drawline(e.pos,playercs[d].pos)&&!1==playercs[d].dead&&dist(e.pos,playercs[d].pos)<t.getrange(t.secondaryitem)){let $=new Attack("Attack",attackfunc,[0,1,0],t.getrange(t.secondaryitem),playercs[d].pos,t,e.pos),u=$.func(!0,t.secondaryitem),h=subtractcost($,e.tc),p=$.warnings.length;0==u.errors.length&&o.push(new ActionNode(e.pos,$,h,e.hazards+p,e.damagepotential+u.avdamageac10,l,n))}}return o}function dashusecase(e,t,n){let i=e.tc[0],s=e.tc[1],o=[],[a,r]=e.pos;if(s>0&&i<=0){let c=new action("Dash",dashfunc,[0,t.tcmax[1],0],0,t.pos,t,e.pos),l=subtractcost(c,e.tc);l[0]+=t.tcmax[0];let d=new ActionNode(e.pos,c,l,e.hazards,e.damagepotential,e,n);o.push(d)}return o}function standgroundusecase(e,t,n){let i=e.tc[0],s=e.tc[1],o=[],[a,r]=e.pos;if(0==s&&i==t.tcmax[0]){let c=new action("Stand Ground",standgroundfunc,[t.tcmax[0],0,0],0,t.pos,t,e.pos),l=subtractcost(c,e.tc);l[1]+=t.tcmax[1];let d=new ActionNode(e.pos,c,l,e.hazards,e.damagepotential,e,n);o.push(d)}return o}function defaultidle(e,t){return Math.random()>.99?1e3:0}function defaultdwarf(e,t){let n=e.tc[1];return(5-n)*chebyshevDistance(e.pos,t.pos)*Math.random()}function defaulthostile(e,t){let[n,i]=e.pos;newgrid[n][i],null==e.parentnode&&(t.knownenemies=[],Object.values(t.visiblecharacters).forEach(function(e){e.character.pc!==t.pc&&t.knownenemies.push(e)}));let s=0,o=e.hazards;newgrid[n][i].gethazards()[1]>0&&o++;let a=e.damagepotential,r=defaulttemperment(e,t);return s-=100*o,s+=10*a,s+=r}function defaulthunting(e,t){let[n,i]=e.pos,s=0;if(null!==e.parentnode&&(s=e.parentutility),null==e.parentnode&&!t.huntmap){let o=99,a;return Object.values(t.huntedcharacters).forEach(function(t){let n=t.lastseen;t.character;let i=chebyshevDistance(e.pos,n)+4*t.getage();i<o&&(o=i,a=t)}),a&&(t.hunted=a,t.huntmap=generatehuntmap(a.lastseen,t,20)),0}return t.huntmap&&t.huntmap[n]&&t.huntmap[n][i]?10*chebyshevDistance([n,i],t.pos):chebyshevDistance([n,i],t.pos)+3*Math.random()}function defaultfleeing(e,t){let[n,i]=e.pos,s=0;return(null==e.parentnode&&(t.knownenemies=[],Object.values(t.visiblecharacters).forEach(function(e){e.character.pc!==t.pc&&t.knownenemies.push(e)}),t.fleemap=generatefleemap(t.knownenemies,t,20)),t.fleemap&&t.fleemap[`${n},${i}`])?(s+=t.fleemap[`${n},${i}`],e.hazards>0&&(s-=5*e.hazards),e.damagepotential>0&&(s+=e.damagepotential),s>10&&e.action&&"Alert"==e.action.name&&(s+=20),s):1e3}function defaulttemperment(e,t){let n=e.activeweapon,[i,s]=e.pos,o=9999,a=Math.floor(n.range);t.knownenemies.forEach(function(e){e.character;let t=e.lastseen,n=Math.floor(dist(t,[i,s]));n<o&&(o=n)});let r=Math.abs(o-a);return o<=n.minrange&&(r=50),-r}function fleeingtemperment(e,t){let[n,i]=e.pos,s=9999;return t.knownenemies.forEach(function(e){e.character;let t=e.lastseen,o=Math.floor(dist(t,[n,i]));o<s&&(s=o)}),-s}function spot(e,t,n){(!t||t.index!=e.index)&&(t&&t.pc==e.pc||(e.getvisibletiles(),e.visiblecharacters={},e.visibletiles.forEach(function(i){let[s,o]=i.pos;if(null!==i.character&&!i.character.dead){let a=i.character,r=a.pos.slice();t&&a.index==t.index&&"Move"==n.name&&(r=n.target),e.visiblecharacters[a.index]=new CharacterMemory(a,r.slice()),!0==a.pc&&e.knowncharacters[a.index]&&(e.knowncharacters[a.index].lastseen[0]!=e.visiblecharacters[a.index].lastseen[0]||e.knowncharacters[a.index].lastseen[1]!=e.visiblecharacters[a.index].lastseen[1])&&(e.actionqueue=[]),e.knowncharacters[a.index]||!0!=a.pc||(e.actionqueue=[]),e.knowncharacters[a.index]=new CharacterMemory(a,r.slice())}e.state.name==e.states[2].name&&e.huntmap&&e.huntmap[s]&&e.huntmap[s][o]&&delete e.huntmap[s][o]}),Object.keys(e.knowncharacters).forEach(function(t){if(!e.visiblecharacters[t]&&e.knowncharacters[t].character.pc!==e.pc){if(!1===drawline(e.pos,e.knowncharacters[t].lastseen)){let n=e.knowncharacters[t].character,i=e.knowncharacters[t].lastseen;e.visiblecharacters[t]=new CharacterMemory(n,i)}else{let s=e.knowncharacters[t].character,o=e.knowncharacters[t].lastseen;e.huntedcharacters[t]=new CharacterMemory(s,o),delete e.knowncharacters[t],e.actionqueue=[]}}e.knowncharacters[t]&&!0==e.knowncharacters[t].character.pc&&(enemyknown=!0)}),e.updatestate()))}function attackofop(e,t,n){if(t&&t.pc!=e.pc){if(1==chebyshevDistance(t.pos,e.pos)&&"Move"==n.name&&chebyshevDistance(n.target,e.pos)>1){let i=new Attack("Attack",attackfunc,[0,0,1],e.getrange(),t.pos,e,e.pos);e.actionqueue.length>0&&(console.log("this enemy is making a reaction, and their action queue wasn't empty"),console.log(e),e.actionqueue=[]),canAffordAction(i,e)&&(e.actionqueue.push(i),move(e))}else if(1==chebyshevDistance(t.pos,e.pos)&&"Attack"==n.name&&chebyshevDistance(n.target,t.pos)>1){let s=new Attack("Attack",attackfunc,[0,0,1],e.getrange(),t.pos,e,e.pos);e.actionqueue.length>0&&(console.log("this enemy is making a reaction, and their action queue wasn't empty"),console.log(e),e.aq=[]),canAffordAction(s,e)&&(e.actionqueue.push(s),move(e))}}}function autopickup(e,t,n){let[i,s]=e.pos;if(newgrid[i][s].objects.length>0&&(newgrid[i][s].objects[0]instanceof Weapon||newgrid[i][s].objects[0]instanceof Ammunition)){let o=newgrid[i][s].objects[0],a=[e.primaryitem,e.secondaryitem],r=!1;a.forEach(function(t){!0!=r&&(t.number<t.stacksize&&o.basename==t.basename||t.ammotype==o.basename)&&(0==e.actionqueue.length?(r=!0,e.actionqueue.unshift(new Get("Get",getfunc,[0,0,0],0,e.pos,e,e.pos)),move(e)):e.actionqueue.length>0&&"Get"!==e.actionqueue[0].name&&(r=!0,e.actionqueue.unshift(new Get("Get",getfunc,[0,0,0],0,e.pos,e,e.pos))))})}}function spot2([e,t]){let n=newgrid[e][t],i=[];i.push(n);let s={};visiblecharacters=[];let o=0;for(;i.length>0&&o<400;){o++;let a=i.shift(),[r,c]=a.pos;if(!1!==drawline([r,c],[e,t])){null!==a.character&&(r!==e||c!==t)&&visiblecharacters.push(a.character);for(let l=r-1;l<=r+1;l++)for(let d=c-1;d<=c+1;d++)s[l]||(s[l]={}),s[l][d]||(s[l][d]=1,i.push(newgrid[l][d]))}}return visiblecharacters}function hear(e,t=!0,n=0){if(performance.now(),chebyshevDistance(e.pos,viewportpos)>e.volume+20)return[];class i{constructor(e,t){this.pos=e,this.volume=t}}let[s,o]=e.pos,a=[],r=new i(e.pos,e.volume),c=new PriorityQueue((e,t)=>t.volume-e.volume);c.enqueue(r);let l=new Set,d=0,$=!1;!0==e.origin.pc&&($=!0);let u=[];for(n=0;!c.isEmpty()&&d<900;){d++;let h=c.dequeue(),[p,m]=h.pos,_=newgrid[p][m],f=_.character,g=`${p},${m}`;if(!l.has(g)&&(l.add(g),_.traversable&&(e.origin.pc,1)&&u.push([p,m,h.volume]),h.volume>=1))for(let w of(null!==f&&(!0==f.pc&&($=!0,0==n&&(n=(e.volume-h.volume)*50)),a.push(f),t&&f.hear(e,h.volume)),directions)){let[b,v]=h.pos.map((e,t)=>e+w[t]),k=`${b},${v}`;if(newgrid[b]&&newgrid[b][v]&&!l.has(k)){let z=1;!1==newgrid[b][v].traversable&&(z=10),0!==Math.abs(b-p)&&0!==Math.abs(v-m)&&(z*=1.4),c.enqueue(new i([b,v],h.volume-z))}}}return!0==newgrid[s][o].visible&&(n=0),!0==$&&u.forEach(function(t){let[i,s,o]=t;if(!0==newgrid[i][s].visible){let a=[o/100,o/100,o/100];setTimeout(()=>{adduilabel("$",[i,s],a,0,!0,!1,!1,!1,.2)},(e.volume-o)*50+n)}}),performance.now(),a}function dist(e,t){let n=Math.abs(e[0]-t[0]),i;return Math.sqrt(n**2+Math.abs(e[1]-t[1])**2)}function repeatchar(e,t){let n="";for(let i=0;i<t;i++)n+=e;return n}function addLineBreaks(e,t){let n="";for(let i=0;i<e.length;i++)n+=e[i],(i+1)%t==0&&i!==e.length-1&&(n+="<br>");return n}function roll(e,t){return randomNumber(e,1)+t}function randomNumber(e,t=0){return Math.floor(Math.random()*(e-t)+t)}function bresenhamLine([e,t],[n,i]){let s=[],o=Math.abs(n-e),a=Math.abs(i-t),r=e<n?1:-1,c=t<i?1:-1,l=o-a;for(;s.push([e,t]),e!==n||t!==i;){let d=2*l;d>-a&&(l-=a,e+=r),d<o&&(l+=o,t+=c)}return s}function shuffle(e){let t=e.length,n,i=e.slice();for(;t>0;)n=Math.floor(Math.random()*t),t--,[i[t],i[n]]=[i[n],i[t]];return i}function deepCopy3D(e){return e.map(e=>e.map(e=>e.map(e=>e)))}function deepCopySubArray3D(e,t,n,i,s){let o=[];for(let a=n;a<=s;a++){o[a-n]=[];for(let r=t;r<=i;r++){o[a-n][r-t]=[];for(let c=0;c<e[0][0].length;c++)o[a-n][r-t][c]=e[a][r][c]}}return o}function deepCopySubArray2D(e,t,n,i,s){let o=[];for(let a=n;a<=s;a++){o[a-n]=[];for(let r=t;r<=i;r++)o[a-n][r-t]=e[a][r]}}function deepCopy2D(e){let t=[];for(let n=0;n<e.length;n++){t[n]=[];for(let i=0;i<e[0].length;i++)t[n][i]=e[n][i]}return t}function partialFill(e,t,n,i,s,o){for(let a=n;a<s;a++)for(let r=i;r<o;r++)e[r][a]=t}function shadowslope([e,t],[n,i]){let s=-Math.abs(i-t)/Math.abs(n-e);chebyshevDistance([e,t],[n,i]);let o=[n+s/Math.sqrt(1+s**2),i+1/Math.sqrt(1+s**2)];o[1],o[0]}function randomSymbol(e){let t=e.length,n=randomNumber(t+1,1)-1;return e[n]}function takeav(e){return e.reduce((e,t)=>e+t)/e.length}function manhattanDistance(e,t){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])}function convertColortoAbs(e){let t=e.map(e=>e/256);return t}function convertAbstoColor(e){let t=e.map(e=>256*e);return t}function randomint(e,t){return e>t&&([e,t]=[t,e]),Math.floor(Math.random()*(t-e+1))+e}function chebyshevDistance(e,t){let[n,i]=e,[s,o]=t;return Math.max(Math.abs(s-n),Math.abs(o-i))}function combineFunctions(e,t){let n=e.bind(this),i=t.bind(this);return()=>{n(),i()}}const conditions={Stunned:new condition("Stunned",skipturn,skipturn,1,!0),StunnedExtra:new condition("Stunned",skipturn,skipturn,1,!1),Surprised:new condition("Surprised",skipturnandyelp,skipturn,1,!0),Prone:new condition("Prone",losemove,losemove,1,!1),Poisoned:new condition("Poisoned",()=>{},takedamage(1),5,!1),Bleeding:new condition("Bleeding",()=>{},takedamage(1),3,!1),Unconscious:new condition("Unconscious",skipturn,1,!1),Confident:new condition("Confident",damagebonus(2),null,2,!1,damagebonus(-2)),Blind:new condition("Blinded",null,null,1,!1,null,null),Burning:new condition("Burning",burn,null,0,!1,null),OnFire:new condition("On Fire",burn,burn,3,!1,null),Overwatch:new condition("Overwatch",null,null,0,!1,null),Resting:new condition("Resting",()=>{},()=>{},0,!1,()=>{})},triggers={},keybindings={Aim:"a - aim attack",Dash:"d - dash",Standground:"s - stand ground",Overwatch:"o - overwatch",SwitchWeapons:"x - switch weapons",GetItem:"g - Get Item",LeaveItem:"l - Leave Item",LeaveItemOffhand:"L - Leave Offhand Item",Zoom:"< > - zoom in and out",Pan:"arrow keys - pan",Reset:"r - reset game"},traits={Cooperative:new trait("Cooperative",hostileallycheck,becomehostile,!0,!0),Surprisable:new trait("Surprisable",hostilecheck,addcondition(conditions.Surprised,!0),!0,!0),Aware:new trait("Aware",hostilecheck,becomehostile,!0,!0),LightSensitive:new trait("Light Sensitive",lightcheck(!0,2),addcondition(conditions.Stunned,!0),!0,!0),LightSensitiveExtra:new trait("Light Sensitive",lightcheck(!0,2),addcondition(conditions.StunnedExtra,!0),!0,!0),LightSensitiveMild:new trait("Light Sensitive",lightcheck(!0,3),addcondition(conditions.Stunned,!0),!0,!0),Overwatch:new trait("Overwatch",function(){if(!1===lackscondition(conditions.Overwatch,this.character))return!0},overwatch,!0,!0),PackTactics:new trait("Pack Tactics",friendlyadjacent,addcondition(conditions.Confident,!1),!0,!1),Sighted:new trait("Sighted",lightcheck(!1,50),addcondition(conditions.Blind),!0,!0)};let procgendebug=!1,characterindex=0;const syncturns=!1;let autodash=!1,cornershadows=!1,partiallos=!0;const dontcaredistance=50;let weight=.02;const mapsizex=200,mapsizey=100;let viewportsizex=48,viewportsizey=24,fontsize=26;const clickfuncs={Raise:function([e,t]){let n=newgrid[e][t].elevation;newgrid[e][t]=new Tile(...tiletypes.DirtFloor,[e,t]),newgrid[e][t].elevation=n+1},Lower:function([e,t]){let n=newgrid[e][t].elevation;newgrid[e][t]=new Tile(...tiletypes.DirtFloor,[e,t]),newgrid[e][t].elevation=n-1},Clear:([e,t])=>newgrid[e][t]=new Tile(...tiletypes.DirtFloor,[e,t]),Wall:([e,t])=>newgrid[e][t]=new Tile(...tiletypes.CavernWall,[e,t])};let clickfunc=clickfuncs.Raise;const directions=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],],cardinaldirections=[[-1,0],[1,0],[0,-1],[0,1],],materials={metal:[.5,.5,.5],water:[.1,.25,.35],stone:[.6,.6,.6],dirt:[.7,.5,.4],abyss:[0,0,0],crystal:[3,3,3],brick:[1,1,1],moss:[.3,.6,.2],wood:[.5,.25,.2],fire:[1,.25,.1],marble:[1,1,1],bone:[1,1,1],blood:[.5,.1,.1]},lights={},tilenames=["Water","Dirt","Stone","Cavern Wall","Moss","Rough Hewn Stone","Rough Hewn Wall"],tiletypes={Water:["Water",materials.water,"~",!0,2,1],DirtFloor:["Dirt Floor",materials.dirt,"&#183",!0,1,1],StoneFloor:["Stone Floor",materials.stone,"&#183",!0,1,1],CavernWall:["Cavern Wall",materials.stone,"#",!1,null,0],MossFloor:["Moss Floor",materials.moss,"&#148",!0,1,1],RoughStoneFloor:["Rough Stone Floor",materials.stone,"&#183",!0,1,1],RoughStoneWall:["Rough Stone Wall",materials.stone,"=",!1,null,0],SmoothstoneFloor:["Smooth Stone Floor",materials.marble,"&#180",!0,1,1],MossyWall:["Mossy Wall",materials.moss,"#",!1,null,0],WoodFloor:["Wood Floor",materials.wood,"&#183",!0,1,1]},tiletypesarr=[tiletypes.Water,tiletypes.DirtFloor,tiletypes.StoneFloor,tiletypes.CavernWall,tiletypes.MossFloor,tiletypes.RoughStoneFloor,tiletypes.RoughStoneWall],actions={SwitchWeapon:["Switch Weapon",switchweapon,[0,0,0],],HalfAttack:["Attack",attackfunc,[0,.5,0]],Attack:["Attack",attackfunc,[0,1,0]],CleaveAttack:["Cleave",cleaveattack,[0,1,0]],GrenadeAttack:["Grenade",grenadeattack,[0,1,0]],Open:["Open",open,[0,0,0],1.9],Dash:["Dash",dashfunc,[0,1,0]]},items={MagicSword:["Magic Sword","/",materials.marble,actions.Attack,1.9,2,6],Grenade:["Grenade","%",[0,0,0],actions.GrenadeAttack,5.9,0,0],Longsword:["Longsword","/",materials.metal,actions.Attack,1.9,0,6,0,null,soundeffects.sworddraw,soundeffects.swordhit,soundeffects.swordswing],BattleAxe:["Battle Axe","/",materials.metal,actions.CleaveAttack,1.9,0,6],Warhammer:["Warhammer","T",materials.metal,actions.ProneAttack,1.9,0,4,0,null,null,soundeffects.clubhit,soundeffects.clubswing],Javelin:["Javelin","|",materials.wood,actions.Attack,3.5,0,4,0,null,soundeffects.tap,soundeffects.arrowflight],Longbow:["Longbow",")",materials.wood,actions.Attack,6.9,0,6,1,1.9,soundeffects.bowdraw,soundeffects.arrowflight],Shortsword:["Shortsword","/",materials.metal,actions.Attack,1.9,0,4,1,null,soundeffects.shortsworddraw],ThrowingDagger:["Throwing Dagger","&#x2020",materials.metal,actions.Attack,3.5,0,2,1,null,soundeffects.daggerdraw,soundeffects.arrowflight],Dagger:["Dagger","&#x2020",materials.metal,actions.Attack,1.9,0,4,1,null,soundeffects.daggerdraw,soundeffects.puncture],Shiv:["Shiv","&#x2020",materials.metal,actions.Attack,1.9,0,2,1,null,soundeffects.daggerdraw],Shortbow:["Shortbow",")",materials.wood,actions.Attack,6.9,0,4,1,1.9,soundeffects.bowdraw],ToxicDart:["Toxic Dart","-",[0,0,0],actions.ProneAttack,6.9,0,2],Net:["Net","#",[0,0,0],actions.Attack,3.9,0,1,1]},statblocks={Deserter:[3,0,2],Exile:[1,2,0],Wanderer:[1,2,0],Goblin:[0,0,0]},enemies={Goblin_Dagger:["Goblin",statblocks.Goblin,4,[5,1,1],!1,"g",[150,125,0],8,[traits.LightSensitive],[new Weapon(...items.Dagger)],[spot,attackofop],darkattackpermute],Goblin_Shortbow:["Goblin",statblocks.Goblin,4,[5,1,1],!1,"g",[100,150,0],8,[traits.LightSensitive],[new Weapon(...items.Shortbow)],[spot,attackofop],darkattackpermute],Goblin_Net:["Goblin",statblocks.Goblin,4,[5,1,1],!1,"g",[150,100,0],8,[traits.LightSensitive],[new Weapon(...items.Net)],[spot,attackofop],function(e,t){return darkattackpermute(conditionattackpermute(conditions.Prone)(e,t))}],Ogre:["Ogre",[3,0,4],12,[3,1,1],!1,"o",[150,125,0],8,[],[new Warhammer],[spot,attackofop],darkattackpermute],Skulker:["Skulker",[0,2,0],5,[10,1,1],!1,"s",[32,32,32],12,[traits.LightSensitive],[new Weapon(...items.ToxicDart)],[spot,attackofop],function(e,t){return darkattackpermute(conditionattackpermute(conditions.Prone)(e,t))}],Wolf:["Wolf",[0,0,0],5,[8,2,1],2,"w",[64,64,64],8,[],[new Weapon(...items.Dagger)],[spot,attackofop]]},objects={TallGrass:["Grass","&#x222B",materials.moss,null,.5,!0,1],Campfire:["Fire","*",materials.fire,null,0,!0,1,null],Door:["Door","+",materials.wood,null,1,!1,0,actions.Open],Table:["Table","&#X20B8",materials.wood,null,.2,!0,2],Chair:["Chair","&#X043F",materials.wood,null,.1,!0,2],Bed:["Bed","0",materials.wood,null,.2,!0,2],Statue:["Statue","&#X03A9",materials.marble,null,.5,!1],Skeleton:["Skeleton","@",materials.bone,null,0,!0,0,null],Sarcophagus:["Sarcophagus","I",materials.stone,null,.5,!1],Curtain:["Curtain","+",materials.wood,null,1,!0,null],Barrel:["Barrel","&#149",materials.wood,null,.25,null]};let tempwallsymbol="#",brightnessadjust=1,viewportoffsety=0,viewportoffsetx=0,throttleRate=33,lastCall=0,enemyturnstart=0,soundoffset=2.5,Q=5,frameticker=0,timeticker=0,checkedframe=!1,noiseupdateticker=0;const noiseupdaterate=100,noisethreshold=.5,waterthreshhold=.6,noiseamount=.1,lightflickerthreshhold=.8,floortiles=["~","&#183","&#183","#","&#148",",","=","+","?"],tileabsorbs=[materials.water,materials.dirt,materials.stone,materials.stone,materials.moss,materials.stone,materials.stone,materials.crystal,materials.abyss,];let diffgens=1;const cdiff=.15,colorbleed=1,gamma=1.4,q=1;let ticktimer=100,renderedlastframe=!0,updatedlighting=!0,updatedsomething=!0,renderqueue=[];const maxlightdist=15,lightrenderdist=10,roomrelation=[[1,2],[2],[1]],roomfuncs={Test:function([e,t]){return[]}},roomtypes={TestRoom:new Roomtype("Test Room",roomfuncs.Test),Barracks:new Roomtype("Barracks",[[3,5],[5,8]],([e,t],[n,i],[s,o],a)=>1),Corridor:new Roomtype("Corridor",[[2,2],[2,2]],([e,t],[n,i],[s,o],a)=>1),CommonArea:new Roomtype("Common Area",[[10,15],[10,15]],([e,t],[n,i],[s,o],a)=>{if(dist([n,i],[s,o])<=Math.max(e,t))return 1}),Bedroom:new Roomtype("Bedroom",[[2,2],[2,2]],()=>1),Entrance:new Roomtype("Entrance",[[10,10],[10,10]],()=>1),Chapel:new Roomtype("Chapel",[[12,12],[20,20]],([e,t],[n,i],[s,o],a)=>{if(dist([n,i],[s,o])<=Math.max(e,t))return 1}),ChapelAntichamber:new Roomtype("Chapel Antichamber",[[1,1],[1,1]],()=>1),Tomb:new Roomtype("Tomb",[[1,1],[1,1]],()=>1),Donut:new Roomtype("Donut",[[3,9],[3,9]],([e,t],[n,i],[s,o],a)=>{if(t=Math.max(e=Math.max(e,t),t),dist([n,i],[s,o])<=Math.min(e,t)&&dist([n,i],[s,o])>=e/4)return 1}),Squonut:new Roomtype("Squonut",[[9,9],[9,9]],([e,t],[n,i],[s,o],a)=>{if(t=Math.max(e=Math.max(e,t),t),chebyshevDistance([n,i],[s,o])>=Math.max(e,t)/2)return 1}),Bossroom:new Roomtype("Bossroom",[[6,6],[6,6]],([e,t],[n,i],[s,o])=>(halfy=Math.floor(e/2),halfx=Math.floor(t/2),0==roomprefabs.Bossroom[s-(n-halfy-2)][o-(i-halfx-2)])?1:2==roomprefabs.Bossroom[s-(n-halfy-2)][o-(i-halfx-2)]?2:void 0,objects.TallGrass)};function updatelightmap(){let e=viewportpos[1]-viewportsizex/2-4,t=viewportpos[0]-viewportsizey/2-4,n=viewportpos[1]+viewportsizex/2+4,i=viewportpos[0]+viewportsizey/2+4;t<0&&(t=0,i=viewportsizey+4),i>mapsizey&&(i=mapsizey,t=mapsizey-(viewportsizey+4)),e<0&&(e=0,n=viewportsizex+4),n>mapsizex&&(n=mapsizex,e=mapsizex-(viewportsizex+4)),updatesightmap(e,t,n,i),updatelighting(e,t,n,i),prunesightmap(e,t,n,i),updatediffusion(e,t,n,i)}function updatesightmap(e,t,n,i){for(let s=t;s<i;s++)for(let o=e;o<n;o++)procgendebug?newgrid[s][o].visible=!0:newgrid[s][o].visible=!1;for(let a=t;a<i;a++)for(let r=e;r<n;r++){newgrid[a][r].visibility=0,newgrid[a][r].los=!1,!1==partiallos&&(newgrid[a][r].visibility=1);for(let c=0;c<playercs.length;c++){if(!1!==drawline(playercs[c].pos,[a,r])&&!0!==playercs[c].dead&&(newgrid[a][r].visibility=Math.max(1-drawline(playercs[c].pos,[a,r]),newgrid[a][r].visibility),newgrid[a][r].visible=!0,1!==newgrid[a][r].readOpacity())){for(let l=a-1;l<=a+1;l++)if(l>0&&l<mapsizey)for(let d=r-1;d<=r+1;d++)d>0&&d<mapsizex&&(newgrid[l][d].visible=!0)}!1!==drawline(playercs[c].pos,[a,r])&&!0!==playercs[c].dead&&(newgrid[a][r].los=!0)}}}function prunesightmap(e,t,n,i){for(let s=t;s<i;s++)for(let o=e;o<n;o++){if(newgrid[s][o].lightlevel<1&&!1!==newgrid[s][o].visible){procgendebug||(newgrid[s][o].visible=!1);for(let a=s-2;a<=s+2;a++)if(a>0&&a<mapsizey){for(let r=o-2;r<=o+2;r++)if(r>0&&r<mapsizex&&newgrid[a][r].lightlevel>0&&1>newgrid[a][r].readOpacity()&&!1!==drawline([s,o],[a,r])){newgrid[s][o].visible=!0;break}}}if(!1==newgrid[s][o].visible||16>takeav(newgrid[s][o].light)){for(let c=0;c<playercs.length;c++)if(1.5>dist([s,o],playercs[c].pos)&&!1!==drawline(playercs[c].pos,[s,o])){newgrid[s][o].visible=!0,newgrid[s][o].light=newgrid[s][o].light.map(e=>16);break}}}}function updatelighting(e,t,n,i){let s=[];for(let o=t;o<i;o++)for(let a=e;a<n;a++){let r=newgrid[o][a].readLightsource();null!=r&&(r.pos=[o,a],s.push(r))}for(let c=t;c<i;c++)for(let l=e;l<n;l++)if(newgrid[c][l].light=[0,0,0],newgrid[c][l].lightlevel=0,!1!==newgrid[c][l].visible&&1>newgrid[c][l].readOpacity())for(let d=0;d<s.length;d++){let{newcolor:$,lightlevel:u}=getlighting(c,l,s[d]);u=Math.max(u,newgrid[c][l].lightlevel),newgrid[c][l].lightlevel=u,newgrid[c][l].light=newgrid[c][l].light.map((e,t)=>e+$[t])}}function updatediffusion(e,t,n,i){for(let s=0;s<diffgens;s++){let o=Array.from({length:i-t},()=>Array(n-e).fill().map(()=>[0,0,0])),a=directions.length;for(let r=t;r<i;r++)for(let c=e;c<n;c++){let l=[0,0,0],d=[r,c];for(let $=0;$<a;$++){let u=directions[$],[h,p]=u.map((e,t)=>e+d[t]);if(newgrid[h]&&newgrid[h][p]){let m=newgrid[h][p].light.slice().map((e,t)=>e*newgrid[h][p].absorbtionBase[t]),_=newgrid[r][c].light.slice().map((e,t)=>.15*e*newgrid[r][c].absorbtionBase[t]),f=takeav(_);newgrid[r][c].elevation<=newgrid[h][p].elevation&&(l=l.map((e,t)=>e+.15*m[t]-(_[t]+f)/2))}}o[r-t][c-e]=newgrid[r][c].light.map((e,t)=>e+l[t])}for(let g=t;g<i;g++)for(let w=e;w<n;w++)newgrid[g][w].light=o[g-t][w-e].slice()}}function oldupdatediffusion(e,t,n,i){for(let s=0;s<diffgens;s++){let o=[];for(let a=t;a<i;a++){o[a-t]=[];for(let r=e;r<n;r++)o[a-t][r-e]=newgrid[a][r].light.slice()}for(let c=t;c<i;c++)for(let l=e;l<n;l++){let d=[0,0,0];if(!0==newgrid[c][l].visible){for(let $=c-1;$<=c+1;$++)if($>0&&$<mapsizey&&$-t>0&&$-t<o.length){for(let u=l-1;u<=l+1;u++)if(u>0&&u<mapsizex&&u-e>0&&u-e<o[0].length&&($!=c||u!=l)&&1>newgrid[$][u].readOpacity()&&2>Math.abs(newgrid[$][u].elevation-newgrid[c][l].elevation)){let h=[0,0,0],p=takeav(h=h.map((n,i)=>.15*o[$-t][u-e][i]*newgrid[c][l].absorbtionBase[i]));h=h.map((e,t)=>(1*h[t]+p)/2),newgrid[$][u].light=newgrid[$][u].light.map((e,t)=>e-p),d=d.map((e,t)=>e+h[t]*(1-newgrid[$][u].readOpacity()))}}}newgrid[c][l].light=newgrid[c][l].light.map((e,t)=>e+d[t])}}}function getlighting(e,t,n){let i=n.color.slice();i=i.map((e,t)=>e*noisemap[n.pos[0]][n.pos[1]]);let s=n.lightpref,o=n.pos,a=newgrid[n.pos[0]][n.pos[1]],r=a.elevation+1,c=dist([e,t],o),l=newgrid[e][t].elevation;r!==newgrid[e][t].elevation&&(c=Math.sqrt(c**2+Math.abs(r-l)**2));let d=Math.min(Math.round(n.radiance+.25-(c-1)/4),n.radiance);if(d<=0)return{newcolor:[0,0,0],lightlevel:0};let $=drawLine3D([...o,r],[e,t,l]);if(!1===$)return{newcolor:[0,0,0],lightlevel:0};d=Math.round(d*(1-$)),d=Math.min(Math.round(n.radiance+.25-(c-1)*(1+$)/4),n.radiance);let u=i.map((e,t)=>1/((c/s[t])**2+.5)*(1-$)),h=i.map((e,t)=>e*u[t]);return{newcolor:h,lightlevel:d}}function generate(){grid=Array(mapsizey).fill(null).map(()=>Array(mapsizex).fill(3)),roomaccretion()}roomtypes.TestRoom.childrooms=[],roomtypes.Barracks.childrooms=[roomtypes.Bedroom,roomtypes.Corridor],roomtypes.Corridor.childrooms=[roomtypes.Bossroom,roomtypes.Barracks,roomtypes.CommonArea,roomtypes.Squonut,roomtypes.Donut],roomtypes.CommonArea.childrooms=[roomtypes.ChapelAntichamber,roomtypes.Corridor],roomtypes.Bedroom.childrooms=[],roomtypes.Entrance.childrooms=[roomtypes.Corridor],roomtypes.ChapelAntichamber.childrooms=[roomtypes.Chapel],roomtypes.Chapel.childrooms=[roomtypes.Tomb],roomtypes.Tomb.childrooms=[],roomtypes.Donut.childrooms=[roomtypes.Barracks,roomtypes.CommonArea,roomtypes.Bossroom],roomtypes.Squonut.childrooms=[roomtypes.Corridor],roomtypes.Bossroom.childrooms=[roomtypes.Donut,roomtypes.Squonut,roomtypes.CommonArea],roomprefabs={Bossroom:[[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,0,1,0,0],[0,0,0,2,0,0,0],[0,0,1,0,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],]};let objectqueue=[],nodemap;function roomaccretion(){nodemap=Array(mapsizey).fill(null).map(()=>Array(mapsizex).fill(null));class e{constructor(e,t,n,i){this.y=e,this.x=t,this.dir=n,this.roomtype=i}}let t=new e(Math.floor(mapsizey/2),Math.floor(mapsizex/2),[0,0],roomtypes.Entrance),n=0,i=0,s=[],o=[];for(s.push(t);(s.length>0||o.length>0)&&n<1e4&&i<100;){for(n++;s.length>0&&n<1e4;){let a=s.shift(),[r,c]=[a.y,a.x];if(c<0||r<0||c>=mapsizex||r>=mapsizey)continue;if(3==grid[r][c]){Math.random()>0?o.unshift(new e(r,c,a.dir,a.roomtype)):(s.push(new e(r,c,a.dir,a.roomtype)),grid[r][c]=1);continue}if(5==grid[r][c])continue;if(4!==grid[r][c])grid[r][c]=5;else{s.push(new e(r+a.dir[0],c+a.dir[1],a.dir,a.roomtype));continue}nodemap[r][c]=a;let l=[[1,0],[-1,0],[0,1],[0,-1]];l=shuffle(l),s.push(new e(r+l[0][0],c+l[0][1],l[0],a.roomtype)),s.push(new e(r+l[1][0],c+l[1][1],l[1],a.roomtype)),s.push(new e(r+l[2][0],c+l[2][1],l[2],a.roomtype)),s.push(new e(r+l[3][0],c+l[3][1],l[3],a.roomtype))}if((o=shuffle(o)).length>0){let d=o.pop(),[$,u]=[d.y,d.x];!1!==h(d.dir,[$,u],d.roomtype)&&i++}}function h(t,n,i){let[o,a,r,c,l,d]=function e(t,n,i){let s=[],o=[],a=[];if(0==i.childrooms.length)return[null,null,null,!1];let r=!0,c=(roomtype=(possiblerooms=shuffle(possiblerooms=i.childrooms.slice()))[0]).roomsize.slice(),l=[randomint(...c[0]),randomint(...c[1])],[d,$]=l=shuffle(l),u=Math.ceil(d/2),h=Math.ceil($/2),[p,m]=[u*t[0]+n[0]+t[0],h*t[1]+n[1]+t[1]];for(let _=p-u-1;_<=p+u+1;_++)for(let f=m-h-1;f<=m+h+1;f++){if(_-12<0||_+12>=mapsizey||f-12<0||f+12>=mapsizex){r=!1;break}if(_>p-u-1&&_<p+u+1&&f>m-h-1&&f<m+h+1){if(1===roomtype.roomshape([u,h],[p,m],[_,f],t)&&(s.push([_,f]),o.push([_,f])),2===roomtype.roomshape([u,h],[p,m],[_,f],t)){s.push([_,f]),o.push([_,f]);let g=new object(...roomtype.objects);g.pos=[_,f],a.push(g)}}else o.push([_,f])}return[s,o,roomtype,r,a]}(t,n,i);for(let $=0;!0==c&&$<a.length;$++){let[u,h]=a[$];if(u-12<0||u+12>=mapsizey||h-12<0||h+12>=mapsizex||null!==nodemap[u][h]){c=!1;break}}if(!c)return!1;grid[n[0]][n[1]]=4;for(let p=0;p<o.length;p++){let[m,_]=o[p];grid[m][_]=1}for(let f=0;l&&f<l.length;f++){let g=l[f];objectqueue.push(g)}s.push(new e(n[0]+t[0],n[1]+t[1],t,r))}}function roomaccretionwhole(){for(let e=0;e<mapsizey;e++){newgrid[e]=[];for(let t=0;t<mapsizex;t++)newgrid[e][t]=new Tile(...tiletypesarr[3],[e,t])}nodemap=Array(mapsizey).fill(null).map(()=>Array(mapsizex).fill(null));class n{constructor(e,t,n,i){this.y=e,this.x=t,this.dir=n,this.roomtype=i}}let[i,s]=[Math.floor(mapsizey/2),Math.floor(mapsizex/2)],o=new n(Math.floor(mapsizey/2),Math.floor(mapsizex/2),[0,0],roomtypes.Entrance);newgrid[i][s]=new Tile(...tiletypesarr[1],[i,s]);let a=0,r=0,c=[],l=[];for(c.push(o);(c.length>0||l.length>0)&&a<1e3&&r<50;){for(a++;c.length>0&&a<1e3;){let d=c.shift(),[$,u]=[d.y,d.x];if(u<0||$<0||u>=mapsizex||$>=mapsizey||null!==nodemap[$][u])continue;if(!1==newgrid[$][u].traversable||newgrid[$][u].objects.length>0){l.push(new n($,u,d.dir,d.roomtype));continue}nodemap[$][u]=d;let h=[[1,0],[-1,0],[0,1],[0,-1]];h=shuffle(h),c.push(new n($+h[0][0],u+h[0][1],h[0],d.roomtype)),c.push(new n($+h[1][0],u+h[1][1],h[1],d.roomtype)),c.push(new n($+h[2][0],u+h[2][1],h[2],d.roomtype)),c.push(new n($+h[3][0],u+h[3][1],h[3],d.roomtype))}if(l.length>0){let p=l.pop(),[m,_]=[p.y,p.x];f(p)}}function f(e){let[t,i]=[e.y,e.x];r++,c.push(new n(t,i,e.dir,e.roomtype)),newgrid[t][i]=new Tile(...tiletypesarr[1],[t,i])}function g(){}}function generateitems(){itemmap=Array(mapsizey).fill(null).map(()=>Array(mapsizex).fill(0));for(let e=0;e<mapsizey;e++)for(let t=0;t<mapsizex;t++);}function generatestartingarea(){let e=[Math.floor(mapsizey/2),Math.floor(mapsizex/2)];for(let t=Math.floor(mapsizey/2)-5;t<Math.floor(mapsizey/2)+5;t++)for(let n=Math.floor(mapsizex/2)-5;n<Math.floor(mapsizex/2)+5;n++)5>dist(e,[t,n])&&(grid[t][n]=1)}function generatemonsters(){nonpcs=[],playercs=[];for(let e=0;e<objectqueue.length;e++){let t=objectqueue[e],[n,i]=t.pos;newgrid[n][i].addObject(t)}for(let s=0;s<mapsizey;s++)for(let o=0;o<mapsizex;o++){if(3==grid[s][o]&&Math.random()>.9&&(newgrid[s][o]=new Tile(...tiletypes.MossyWall,[s,o])),5==grid[s][o]&&Math.random()>.95&&(newgrid[s][o]=new Tile(...tiletypes.MossFloor,[s,o]),Math.random()>.5&&newgrid[s][o].addObject(new object(...objects.TallGrass))),nodemap[s][o]&&"Tomb"==nodemap[s][o].roomtype.roomname&&Math.random()>.9&&newgrid[s][o].addObject(new Sarcophagus),nodemap[s][o]&&"Common Area"==nodemap[s][o].roomtype.roomname&&Math.random()>.95)for(Math.random()>.5?newgrid[s][o].addObject(new oilBarrel(...objects.Barrel)):newgrid[s][o].addObject(new oilLamp),localy=s-1;localy<=s+1;localy++)for(localx=o-1;localx<=o+1;localx++)(s!==localy||o!==localx)&&(localx==o||localy==s)&&Math.random()>.5&&!0==newgrid[localy][localx].traversable&&newgrid[localy][localx].addObject(new object(...objects.Chair));nodemap[s][o]&&"Bedroom"==nodemap[s][o].roomtype.roomname&&Math.random()>.9&&newgrid[s][o].addObject(new object(...objects.Bed)),nodemap[s][o]&&"Chapel"==nodemap[s][o].roomtype.roomname&&(newgrid[s][o]=new Tile(...tiletypes.SmoothstoneFloor,[s,o]),Math.random()>.99?newgrid[s][o].addObject(new bonfire(...objects.Campfire)):Math.random()>.96&&newgrid[s][o].addObject(new object(...objects.Statue))),5==grid[s][o]&&Math.random()>.95&&nodemap[s][o].roomtype&&"Chapel"!==nodemap[s][o].roomtype.roomname?Math.random()>.4?newgrid[s][o].addCharacter(new Goblin_Dagger([s,o])):Math.random()>.2?newgrid[s][o].addCharacter(new Goblin_Shortbow([s,o])):Math.random()>.5?Math.random()>.75?newgrid[s][o].addCharacter(new Giant([s,o])):newgrid[s][o].addCharacter(new Ogre([s,o])):newgrid[s][o].addCharacter(new Skulker([s,o])):4==grid[s][o]&&(newgrid[s][o]=new Tile(...tiletypes.RoughStoneFloor,[s,o]),newgrid[s][o].addObject(new door(...objects.Door)))}let[a,r]=[Math.floor(mapsizey/2),Math.floor(mapsizex/2)];newgrid[a][r].addCharacter(new playerCharacter([a,r],"Deserter",statblocks.Deserter,10,[4,1,1],!0,"@",[128,128,128],16,[traits.LightSensitiveMild],[new Torch])),newgrid[a+1][r+1].addCharacter(new playerCharacter([a+1,r+1],"Fugitive",statblocks.Exile,6,[4,1,1],!0,"@",[0,32,0],14,[traits.LightSensitiveMild],[],sneakattackpermute)),newgrid[a-1][r-1].addCharacter(new playerCharacter([a-1,r-1],"Huntsman",statblocks.Wanderer,5,[4,1,1],!0,"@",[128,96,64],14,[traits.LightSensitiveMild],[],sharpshooterpermute)),updatecharacters(),updatecharactershere(),activecharacternonindex=playercs[0]}function differentiategrid(e){seedgrid=gradientNoise(mapsizex,mapsizey,.1,Math.random());for(let t=0;t<mapsizey;t++)for(let n=0;n<mapsizex;n++)3===e[t][n]&&(Math.random()-.3>bias(wallratio=seedgrid[t][n],30)?e[t][n]=1:e[t][n]=3)}function generatecavern(e){for(let t=0;t<5;t++){let n=deepCopy2D(e);for(let i=0;i<mapsizey;i++)for(let s=0;s<mapsizex;s++){let o=0;for(let a=i-1;a<=i+1;a++)for(let r=s-1;r<=s+1;r++)if(a!==i||r!==s){if(r<0||r>mapsizex-1||a<0||a>mapsizey-1){o++;continue}3==n[a][r]&&o++}o>3&&(e[i][s]=3),o<4&&(e[i][s]=1)}}}function generatecavernfloor(e){for(let t=0;t<mapsizey;t++)for(let n=0;n<mapsizex;n++)if(1==e[t][n]){let i=Math.random();i>2/3?e[t][n]=1:i>1/3?e[t][n]=0:i>0&&(e[t][n]=2)}for(let s=0;s<2;s++){let o=deepCopy2D(e);for(let a=0;a<mapsizey;a++)for(let r=0;r<mapsizex;r++){if(3==e[a][r])continue;let c=0,l=0,d=0,$=0;for(let u=a-1;u<=a+1;u++)for(let h=r-1;h<=r+1;h++)if(u!==a||h!==r){if(h<0||h>mapsizex-1||u<0||u>mapsizey-1)continue;if(0==o[u][h]){c++;continue}if(1==o[u][h]){d++;continue}if(2==o[u][h]){l++;continue}if(4==o[u][h]){$++;continue}}l>3?e[a][r]=2:c+$>3?Math.random()>.25?e[a][r]=0:e[a][r]=4:d>3&&(e[a][r]=1)}}}function generatedungeons(e){noiseCAdungeons(e)}function identifyentrances(e){let t=[];for(let n=0;n<mapsizey;n++){t[n]=[];for(let i=0;i<mapsizex;i++)t[n][i]=-1}for(let s=0;s<mapsizey;s++)for(let o=0;o<mapsizex;o++)if(3==e[s][o]){let a=0,r=0;for(let c=s-1;c<=s+1;c++)for(let l=o-1;l<=o+1;l++)if(c!==s||l!==o){if(l<0||l>mapsizex-1||c<0||c>mapsizey-1||l!==o&&c!==s)continue;(1==e[c][l]||2==e[c][l])&&r++,5==e[c][l]&&a++}a>0&&r>0&&(t[s][o]=0)}return t}function locatedungeons(){for(let e=0;e<2;e++){let t=deepCopy2D(grid);for(let n=0;n<mapsizey;n++)for(let i=0;i<mapsizex;i++){let s=0;for(let o=n-1;o<=n+1;o++)for(let a=i-1;a<=i+1;a++)if(o!==n||a!==i){if(a<0||a>mapsizex-1||o<0||o>mapsizey-1){s++;continue}3==t[o][a]&&s++}8==s&&(grid[n][i]=5)}}}function extendedCA(e){seedgrid=gradientNoise(mapsizex,mapsizey,.2,Math.random());let t=.5;for(let n=0;n<mapsizey;n++){e[n]=[];for(let i=0;i<mapsizex;i++)Math.random()>bias(t=seedgrid[n][i],2)?e[n][i]=1:e[n][i]=3}for(let s=0;s<10;s++){let o=deepCopy2D(e);for(let a=0;a<mapsizey;a++)for(let r=0;r<mapsizex;r++){let c=0,l=0;for(let d=a-2;d<=a+2;d++)for(let $=r-2;$<=r+2;$++){let u=!1;if(d!==a||$!==r){if($<0||$>mapsizex-1||d<0||d>mapsizey-1){c++,l++;continue}$!==r&&d!==a&&(u=!0),3==o[d][$]&&(c++,!1==u&&l++)}}s<10&&3==o[a][r]&&(l>99||l<4)&&(e[a][r]=1),s<8&&1==o[a][r]&&(l>4||c>99||l<2&&Math.random()>.5)&&(e[a][r]=3)}}}function noiseCAdungeons(e){seedgrid=gradientNoise(mapsizex,mapsizey,.2,Math.random());let t=.5;for(let n=0;n<mapsizey;n++)for(let i=0;i<mapsizex;i++)5==e[n][i]&&(t=seedgrid[n][i],Math.random()+.1>bias(seedgrid[n][i],1.5)?e[n][i]=5:e[n][i]=6);for(let s=0;s<10;s++){let o=deepCopy2D(e);for(let a=0;a<mapsizey;a++)for(let r=0;r<mapsizex;r++){let c=0,l=0;for(let d=a-1;d<=a+1;d++)for(let $=r-1;$<=r+1;$++){let u=!1;if(d!==a||$!==r){if($<0||$>mapsizex-1||d<0||d>mapsizey-1){c++,l++;continue}$!==r&&d!==a&&(u=!0),6==o[d][$]&&(c++,!1==u&&l++)}}s<10&&6==o[a][r]&&(l>99||l<2||l<3&&Math.random()>1)&&(e[a][r]=5),s<8&&5==o[a][r]&&(l>2||c>8||l<1&&Math.random()>.5)&&(e[a][r]=6)}}}function BSPandCA(){grid=generateRooms(mapsizex,mapsizey,8,4);for(let e=0;e<30;e++){let t=deepCopy2D(grid);for(let n=0;n<mapsizey;n++)for(let i=0;i<mapsizex;i++){let s=0,o=0;for(let a=n-1;a<=n+1;a++)for(let r=i-1;r<=i+1;r++){let c=!1;if(a!==n||r!==i){if(r<0||r>mapsizex-1||a<0||a>mapsizey-1){s++;continue}r!==i&&a!==n&&(c=!0),3==t[a][r]&&(s++,!1==c&&o++)}}e<9999&&3==t[n][i]&&(5==s&&3==o&&Math.random()>.995||3==o&&7==s)&&(grid[n][i]=1),29==e&&3==t[n][i]&&2==o&&4==s&&(grid[n][i]=1),e<0&&1==t[n][i]&&(o>2||s>3||s<1&&.3>Math.random())&&(grid[n][i]=3)}}}function gradientNoise(e,t,n=.01,i=0){let s=Array(t).fill().map(()=>Array(e).fill(0)),o={0:[1,0],1:[0,1],2:[-1,0],3:[0,-1],4:[Math.sqrt(2)/2,Math.sqrt(2)/2],5:[-Math.sqrt(2)/2,Math.sqrt(2)/2],6:[-Math.sqrt(2)/2,-Math.sqrt(2)/2],7:[Math.sqrt(2)/2,-Math.sqrt(2)/2]};function a(e,t,n,s){var a,r;let c=(a=e,r=t,o[Math.floor(8*Math.abs(2920*Math.sin(i+21942*a+171324*r+8912)*Math.cos(i+23157*a*r*217832+9758)))%8]);return(n-e)*c[0]+(s-t)*c[1]}function r(e,t){let n=Math.floor(e),i=n+1,s=Math.floor(t),o=s+1,r=e-n,c=a(n,s,e,t),l=a(i,s,e,t),d=lerp(c,l,r),$=a(n,o,e,t),u=a(i,o,e,t),h=lerp($,u,r);return lerp(d,h,t-s)}for(let c=0;c<t;c++)for(let l=0;l<e;l++)s[c][l]=r(l*n,c*n)/2+.5;return s}function lerp(e,t,n){return(1-n)*e+n*t}function bias(e,t){return e>.5?1-Math.pow(1-e,t):Math.pow(e,t)}nodemap=Array(mapsizey).fill(null).map(()=>Array(mapsizex).fill(null));class Node{constructor(e){this.boundary=e,this.left=null,this.right=null,this.isLeaf=!0,this.room=null}}class BSP{constructor(e,t,n){this.root=new Node({x:0,y:0,width:e,height:t}),this.minRoomSize=n}split(e,t){if(0===t||e.boundary.width<2*this.minRoomSize||e.boundary.height<2*this.minRoomSize){let n=Math.floor(Math.random()*(e.boundary.width-this.minRoomSize)+this.minRoomSize),i=Math.floor(Math.random()*(e.boundary.height-this.minRoomSize)+this.minRoomSize),s=Math.floor(Math.random()*(e.boundary.width-n)),o=Math.floor(Math.random()*(e.boundary.height-i));e.room={x:e.boundary.x+s,y:e.boundary.y+o,width:n,height:i};return}let a=e.boundary.width/e.boundary.height,r;if(r=a>1?Math.random()<(a/(a+1))**.5:Math.random()>(1/(a+1))**.5){let c=this.minRoomSize,l=e.boundary.width-this.minRoomSize,d=Math.floor(c+(l-c)*bellCurveRandom());e.left=new Node({x:e.boundary.x,y:e.boundary.y,width:d,height:e.boundary.height}),e.right=new Node({x:e.boundary.x+d,y:e.boundary.y,width:e.boundary.width-d,height:e.boundary.height})}else{let $=this.minRoomSize,u=e.boundary.height-this.minRoomSize,h=Math.floor($+(u-$)*bellCurveRandom());e.left=new Node({x:e.boundary.x,y:e.boundary.y,width:e.boundary.width,height:h}),e.right=new Node({x:e.boundary.x,y:e.boundary.y+h,width:e.boundary.width,height:e.boundary.height-h})}e.isLeaf=!1,this.split(e.left,t-1),this.split(e.right,t-1)}build(e){this.split(this.root,e)}traverseLeaves(e,t){e.isLeaf?t(e):(e.left&&this.traverseLeaves(e.left,t),e.right&&this.traverseLeaves(e.right,t))}}function generateRooms(e,t,n,i){let s=Array.from({length:t},()=>Array(e).fill(3)),o=new BSP(e,t,i);return o.build(n),o.traverseLeaves(o.root,e=>{if(e.room){let t=Math.floor(Math.random()*(e.room.width-i+1))+i,n=Math.floor(Math.random()*(e.room.height-i+1))+i,o=Math.floor(Math.random()*(e.room.width-t+1)),a=Math.floor(Math.random()*(e.room.height-n+1));for(let r=0;r<n;r++)for(let c=0;c<t;c++)s[e.room.y+a+r][e.room.x+o+c]=1}}),s}function bellCurveRandom(){let e=0;for(let t=0;t<5;t++)e+=Math.random();return e/5}function drawpath(e,t){path=floodFill(grid,e[0],e[1])}function floodFill(e,t,n){let i=[[t,n]],s=[];for(;i.length>0;){let[o,a]=i.shift();if(!(a<0)&&!(o<0)&&!(a>=mapsizex)&&!(o>=mapsizey)&&7!=e[o][a]){if(3==e[o][a]||6==e[o][a]){e[o][a]=7;continue}s.push([o,a]),e[o][a]=7,i.push([o+1,a]),i.push([o-1,a]),i.push([o,a+1]),i.push([o,a-1])}}}function modifiedFloodFill(e,t,n){entrancemap=identifyentrances(e),referencemap=deepCopy2D(e);let i=[[t,n]],s=[],o=1;for(;i.length>0||s.length>0;){for(;i.length>0;){let[a,r]=i.shift();if(!(r<0)&&!(a<0)&&!(r>=mapsizex)&&!(a>=mapsizey)){if(entrancemap[a][r]>-1){entrancemap[a][r]++,s.push([a,r]);continue}7!=referencemap[a][r]&&3!=referencemap[a][r]&&6!=referencemap[a][r]&&(referencemap[a][r]=7,o++,i.push([a+1,r]),i.push([a-1,r]),i.push([a,r+1]),i.push([a,r-1]))}}if(s.length>0){let c=s.pop();(entrancemap[c[0]][c[1]]<2||.05>Math.random()&&entrancemap[c[0]][c[1]]<3)&&(e[c[0]][c[1]]=2,referencemap[c[0]][c[1]]=1,entrancemap[c[0]][c[1]]=-1,i.push(c))}}o<.5*mapsizex*mapsizey&&(console.log("too closed off"),generate())}function modifiedAstar(e,t,n=50,i=0){let s=grid.length,o=grid[0].length,a=[[-1,0],[1,0],[0,-1],[0,1]];function r(n,i){let a=!0;return!1!==ischarhere(n,i)&&(n!==e[0]||i!==e[1])&&(n!==t[0]||i!==t[1])&&(a=!1),n>=0&&i>=0&&n<s&&i<o}let c=new PriorityQueue((e,t)=>e.f-t.f),l=Array(s).fill(null).map(()=>Array(o).fill(1/0)),[d,$]=e;l[d][$]=0,c.enqueue({x:$,y:d,f:0}),bresenhamLine(e,t);let u=1,h=0;for(;!c.isEmpty();){let p=c.dequeue();if(p.x===t[1]&&p.y===t[0]||dist([p.y,p.x],t)<=i){let m=[],_=p;for(;_;)m.push([_.y-e[0],_.x-e[1]]),_=_.parent;return m.pop(),m.reverse()}for(let[f,g]of a){let w=p.y+g,b=p.x+f;if(r(w,b)){let v=l[p.y][p.x]+1;if(6==grid[p.y][p.x]&&(v+=999),3==grid[p.y][p.x]&&(v+=10),v<l[w][b]){l[w][b]=v;let k=Math.abs(w-t[0]),z=Math.abs(b-t[1]),E;E=k>z?k+.9*z:z+.9*k;let A=v+E;c.enqueue({x:b,y:w,f:A,parent:p})}}}u++,h++}return null}gameText=document.getElementById("game-text"),document.addEventListener("keydown",function(e){let t=activecharacternonindex;if(("Space"===e.code||" "===e.key)&&!1==controllock&&playerendturn(),"o"==e.key&&(uilock&&(uilock=!1),!1==controllock&&!1==uilock&&t.tc[1]>=1&&(t.actionqueue=[],t.actionqueue.push(new action("Overwatch",startoverwatch,[0,1,0],0,t.pos,t,t.pos)),move(t))),"d"===e.key&&!1==controllock&&t.tc[1]>=1&&(t.actionqueue.push(new action("Dash",dashfunc,[0,1,0],0,t.pos,t,t.pos)),playertick(t)),"s"===e.key&&!1==controllock&&t.tc[0]>=t.tcmax[0]&&(t.actionqueue.push(new action("Stand Ground",standgroundfunc,[t.tcmax[0],0,0],0,t.pos,t,t.pos)),playertick(t)),"<"===e.key&&fontsize>26&&(viewportsizex+=4,viewportsizey+=2,fontsize=Math.round(1248/viewportsizex),updatedsomething=!0),">"===e.key&&fontsize<44&&(viewportsizex-=4,viewportsizey-=2,fontsize=Math.round(1248/viewportsizex),updatedsomething=!0),"ArrowLeft"===e.key&&viewportoffsetx>-5&&(viewportoffsetx--,viewportpos[1]--,updatedsomething=!0),"ArrowRight"===e.key&&viewportoffsetx<5&&(viewportoffsetx++,viewportpos[1]++,updatedsomething=!0),"ArrowUp"===e.key&&viewportoffsety>-5&&(viewportoffsety--,viewportpos[0]--,updatedsomething=!0),"ArrowDown"===e.key&&viewportoffsety<5&&(viewportoffsety++,viewportpos[0]++,updatedsomething=!0),"a"===e.key&&!1==controllock){let n=playercs[activecharacter];n.tc[1]>=1&&(!1==uilock?(uilock=!0,updatedsomething=!0):(uilock=!1,updatedsomething=!0))}if("r"===e.key&&gridinit(),"x"===e.key&&!1===controllock){let i=playercs[activecharacter],s=new action(...actions.SwitchWeapon,0,i.pos,i,i.pos);i.actionqueue.push(s),playertick()}if("g"===e.key&&!1===controllock&&!1===uilock){let o=playercs[activecharacter];newgrid[o.pos[0]][o.pos[1]].objects.length>0&&newgrid[o.pos[0]][o.pos[1]].objects[0]instanceof Item&&(o.actionqueue.push(new action("Get",getfunc,[0,0,0],0,o.pos,o,o.pos)),playertick())}if("l"===e.key&&!1===controllock&&!1===uilock){let a=playercs[activecharacter];a.actionqueue.push(new action("Leave",leavefunc,[0,0,0],0,a.pos,a,a.pos)),playertick()}if("L"===e.key&&!1===controllock&&!1===uilock){let r=playercs[activecharacter];r.actionqueue.push(new action("Leave",leavefuncoffhand,[0,0,0],0,r.pos,r,r.pos)),playertick()}"+"===e.key&&brightnessadjust<2.1&&(brightnessadjust+=.1,updatedsomething=!0),"-"===e.key&&brightnessadjust>.4&&(brightnessadjust-=.1,updatedsomething=!0),"?"===e.key?(keyglossary=!keyglossary,updatedsomething=!0):(keyglossary=!1,updatedsomething=!0)}),document.addEventListener("wheel",function(e){e.deltaY<0&&fontsize>26?(viewportsizex+=4,viewportsizey+=2,fontsize=Math.round(1248/viewportsizex),updatedsomething=!0):e.deltaY>0&&fontsize<44&&(viewportsizex-=4,viewportsizey-=2,fontsize=Math.round(1248/viewportsizex),updatedsomething=!0)}),document.addEventListener("DOMContentLoaded",function(){document.addEventListener("contextmenu",function(e){e.preventDefault()})}),gameText.addEventListener("mouseover",e=>{if(e.target.classList.contains("clickable")){let t=e.target.getAttribute("x"),n=e.target.getAttribute("y"),i=[parseInt(n),parseInt(t)];(cursorpos[0]!=n||cursorpos[1]!=t)&&(showdetails=!1,cursorpos[0]=i[0],cursorpos[1]=i[1],updatedlighting=!0)}else cursorpos=[0,0]}),gameText.addEventListener("mousedown",e=>{if(keyglossary=!1,e.target.classList.contains("clickable")&&0==e.button&&(!1==controllock&&!1==uilock&&moveplayer(),!1==controllock&&!0==uilock)){let t=playercs[activecharacter],n=actions.Attack;t.actionqueue.push(new Attack(...n,t.getrange(),cursorpos,t,t.pos)),canAffordAction(t.actionqueue[0],t)&&playertick(t),uilock=!1}if(e.target.classList.contains("clickable")&&2==e.button){let i=e.target.getAttribute("x"),s=e.target.getAttribute("y");parseInt(s),parseInt(i),!1==controllock&&(showdetails=!0)}});let viewportpos=[50,50],gamelog=["","","","","","","","","","","","","","","","",""],cursorlog="this is the cursor log",cursorpos=[0,0],keyglossary=!1,score=0,itemmap=[],grid=[],newgrid=[],noisemap=Array(mapsizey).fill(null).map(()=>Array(mapsizex).fill(1)),uielements=[],animationelements={},characters=[],charactershere=[],nonpcshere=[],objectshere=[],envobjects=[],playercs=[],nonpcs=[],turncounter=0,activecharacter=0,activecharacternonindex=null,tickcounter=0,controllock=!1,uilock=!1,showdetails=!1,lightsources=[],messageQueue=[],isProcessing=!1;function gridinit(){envobjects=[],score=0,generate(),generate(),updatecharacters();let[e,t]=[mapsizey/2,mapsizex/2];for(let n=0;n<mapsizey;n++){newgrid[n]=[];for(let i=0;i<mapsizex;i++)newgrid[n][i]||(newgrid[n][i]=new Tile(...tiletypesarr[grid[n][i]],[n,i]))}elevupdate(),generatemonsters(),updateGrid(),updatecharactershere(),updateGrid(),drawGrid(!0),nonpcs.forEach(function(e){spot(e)})}function elevupdate(){for(let e=0;e<mapsizey;e++)for(let t=0;t<mapsizex;t++){if(!newgrid[e][t].traversable)continue;let n=[e,t];directions.forEach(function(i){let[s,o]=i.map((e,t)=>e+n[t]);newgrid[s]&&newgrid[s][o]&&newgrid[s][o].traversable&&(newgrid[e][t].elevation-newgrid[s][o].elevation<-1&&(newgrid[e][t].symbolBase=linecharacterdiagonalpreference([e,t],[mapsizey/2+.5,mapsizex/2+.5]),newgrid[e][t].traversable=!1),newgrid[e][t].elevation,newgrid[s][o].elevation)})}for(let i=0;i<mapsizey;i++)for(let s=0;s<mapsizex;s++){if(!newgrid[i][s].traversable)continue;let o=newgrid[i][s],a=o.elevation,r=[],c=[];cardinaldirections.forEach(function(e){let[t,n]=e.map((e,t)=>e+o.pos[t]);newgrid[t]&&newgrid[t][n]&&(newgrid[t][n].elevation==a-1&&r.push([t,n]),newgrid[t][n].elevation==a+1&&c.push([t,n]))}),c.length>0&&r.length>0&&c.forEach(function([e,t]){r.forEach(function([n,o]){let a=e-n,r=t-o;2==a&&0==r&&(newgrid[i][s].traversable=!0,newgrid[i][s].symbolBase="&#9650"),-2==a&&0==r&&(newgrid[i][s].traversable=!0,newgrid[i][s].symbolBase="&#9660"),2==r&&0==a&&(newgrid[i][s].traversable=!0,newgrid[i][s].symbolBase="&#9664"),-2==r&&0==a&&(newgrid[i][s].traversable=!0,newgrid[i][s].symbolBase="&#9654")})})}}function alinedraw(e,t,n){if(!playercs[activecharacter]){console.log(activecharacter);return}if(!e||0==e.length)return;let i=translateAStoAQ(e,n),s=n.tc.slice(),o=n.pos;for(let a=0;a<i.length;a++){let[r,c]=i[a].target;if(a>0&&(o=i[a-1].target),!(s[0]>=i[a].cost[0])||!(s[1]>=i[a].cost[1]))return s;if("Move"==i[a].name&&(cost=i[a].cost[0],newgrid[r][c].uiElements.push(new uielement("",[.25*cost**2,.25,.25],[r,c]))),"Attack"==i[a].name){i[a].func(!0);let l=bresenhamLine(o,i[a].target),d=linecharacter(o,i[a].target);for(let $=1;$<l.length;$++){let[u,h]=l[$];$==l.length-1&&(d="x"),newgrid[u][h].uiElements.push(new uielement(d,[1,1,1],[u,h]))}}if(0!==i[a].warnings.length&&adduilabel("x",i[a].pos,[128,0,0],0,!1,!1),s=s.map((e,t)=>e-i[a].cost[t]),a==i.length-1)return s}}function addanimation(e,t,n,i=1,s=!0,o=!1){let a=[],r=e.length;for(let c=0;c<r;c++){let[l,d]=e[c];if(!newgrid[l]||!newgrid[l][d])continue;a.push(`${e[c][0]},${e[c][1]},${performance.now()},${performance.now()+6*i*ticktimer}`);let $=t[c%t.length];animationelements[a[c]]=new uielement($,n,e[c],s,o)}updatedsomething=!0,setTimeout(function(){for(let e=0;e<r;e++)delete animationelements[a[e]];updatedsomething=!0},6*ticktimer*i)}function noiseupdate(){let e=viewportpos[1]-Math.floor(viewportsizex/2),t=viewportpos[0]-Math.floor(viewportsizey/2),n=viewportpos[1]+Math.floor(viewportsizex/2),i=viewportpos[0]+Math.floor(viewportsizey/2);t<0&&(t=0,i=viewportsizey),i>mapsizey&&(i=mapsizey,t=mapsizey-viewportsizey),e<0&&(e=0,n=viewportsizex),n>mapsizex&&(n=mapsizex,e=mapsizex-viewportsizex);for(let s=t;s<i;s++)for(let o=e;o<n;o++)if(!1!==newgrid[s][o].visible&&takeav(newgrid[s][o].light)>1){let a=takeav(newgrid[s][o].light)/256,r=newgrid[s][o].readLightsource();if(Math.random()>.5+a**.05*.5||r&&(Math.random()>.8||1==r.radiance&&Math.random()>.5)){let c=.9+.2*Math.random();noisemap[s][o]=c}}updatedlighting=!0,updateambientsound()}function updateGrid(){let e=function e(){let t=[],n=[],i=[];for(let s=0;s<1;s++)!1==playercs[s].dead&&(n.push(playercs[s].pos[0]),i.push(playercs[s].pos[1]));if(0==n.length){gridinit();return}return[Math.round(takeav(n)),Math.round(takeav(i))]}();e&&dist(e,viewportpos)>2&&(viewportpos[0]=e[0],viewportpos[1]=e[1])}function updateconditions(e){for(let t=e.conditions.length-1;t>=0;t--)e.conditions[t].duration--,e.conditions[t].duration<=-1?(null!=e.conditions[t].endeffect&&e.conditions[t].endeffect(),e.conditions.splice(t,1)):e.conditions[t].turneffect()}function updatetraitspassive(){for(let e=0;e<nonpcshere.length;e++){let t=nonpcshere[e];if(!0!==t.dead)for(let n=0;n<t.traits.length;n++){let i=t.traits[n];!0==i.passive&&!0==i.trigger()&&i.effect()}}for(let s=0;s<playercs.length;s++){let o=playercs[s];if(!0!=o.dead)for(let a=0;a<o.traits.length;a++){let r=o.traits[a];!0==r.passive&&!0==r.trigger()&&r.effect()}}for(let c=0;c<objectshere.length;c++){let l=objectshere[c];for(let d=0;d<l.effects.length;d++){let $=l.effects[d];$(l)}}}function updatetraitsactive(e){for(let t=0;t<e.traits.length;t++){let n=e.traits[t];!0==n.active&&!0==n.trigger()&&n.effect()}}function playerturn(){0==activecharacter&&turncounter++,!0==(pc=playercs[activecharacter]).dead&&playerendturn(),pc.tc=pc.tcmax.slice(),updateconditions(pc),updatetraitsactive(pc),controllock=!1,activecharacternonindex=playercs[activecharacter]}function playertick(){controllock=!0;let e=playercs[activecharacter];if(e.hp<=0&&(e.dead=!0),!0==e.dead){playerendturn();return}if(e.tc[0]<=0&&e.tc[1],e.actionqueue.length>0){let t=1;canAffordAction(e.actionqueue[0],e)?(e.actionqueue[0].cost[1]>0&&(t=10),move(e),updatetraitspassive()):e.actionqueue=[],setTimeout(playertick,ticktimer*t),updateGrid();return}playercs[activecharacter].actionqueue=[],0==playercs[activecharacter].actionqueue.length&&(controllock=!1)}function playerendturn(){if(updatetraitspassive(),updatecharactershere(),nonpcshere=shuffle(nonpcshere),uilock=!1,++activecharacter<playercs.length){if(!0==playercs[activecharacter].dead){playerendturn();return}playerturn();return}activecharacter=0,controllock=!0,updateEnvironment(),setTimeout(enemyturn,ticktimer)}function restcheck(){let e=0;playercs.forEach(function(t){(!0!==lackscondition(conditions.Resting,t)||!0==t.dead||!0!==lackscondition(conditions.Overwatch,t))&&e++}),e==playercs.length&&playercs.forEach(function(e){!e.dead&&e.hp<e.maxhp&&(e.heal(e.maxhp-e.hp),directions.forEach(function(t){let[n,i]=t.map((t,n)=>t+e.pos[n]);if(newgrid[n][i].objects.length>0){let s=newgrid[n][i].objects[0];s instanceof bonfire&&s.extinguish()}}))})}function updateEnvironment(){let e=envobjects.slice();for(envobjects=[];e.length>0;){let t=e.shift();t.update()}}function enemyturn(){if(0==activecharacter&&(enemyturnstart=performance.now()),activecharacter>=nonpcshere.length){activecharacter=0,playerturn();return}let e=nonpcshere[activecharacter];if(activecharacternonindex=e,activecharacter++,manhattanDistance(e.pos,viewportpos)<dontcaredistance&&!1==e.dead){e.tc=e.tcmax.slice(),e.state,tickcounter=0,updateconditions(e),updatetraitsactive(e),function e(t){let n=1;if(++tickcounter>20){t.actionqueue=[],enemyturn();return}if(t.hp<=0&&(t.dead=!0),!0==t.dead){enemyturn();return}if(t.tc[0]>0||t.tc[1]>0){if(t.actionqueue.length>0){if(canAffordAction(t.actionqueue[0],t)){t.actionqueue[0].cost[1]>0&&(n=10);let[i,s]=t.actionqueue[0].target;!0!==newgrid[t.pos[0]][t.pos[1]].visible&&!0!==newgrid[i][s].visible&&(n=0),move(t)}else{t.actionqueue=[],enemyturn();return}}else{let o=planturn(t);if(o.length>0){if(t.actionqueue=o.slice(),t.actionqueue.push(new endTurn("End Turn",endturnfunc,[0,0,0],0,t.pos,t,t.pos)),t.actionqueue.length<1){enemyturn();return}}else{t.actionqueue=[],enemyturn();return}}}t.tc[0]>0||t.tc[1]>0?(!0!==newgrid[t.pos[0]][t.pos[1]].visible&&(n=0),n*ticktimer==0&&(!t.actionqueue[0]||!t.actionqueue[0].loudness||t.actionqueue[0].loudness<chebyshevDistance(viewportpos,t.pos))&&t.index%10!=0?e(t):setTimeout(function(){e(t),updateGrid()},ticktimer*n)):(t.actionqueue=[],enemyturn())}(e);return}enemyturn()}function aStar(e,t,n=50,i=0){let s=mapsizey,o=mapsizex,a=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1],];function r(n,i){let a=!0;return null!==newgrid[n][i].character&&(n!==e[0]||i!==e[1])&&(n!==t[0]||i!==t[1])&&(a=!1),n>=0&&i>=0&&n<s&&i<o&&!0===newgrid[n][i].traversable&&!0==a}let c=new PriorityQueue((e,t)=>e.f-t.f),l=Array(s).fill(null).map(()=>Array(o).fill(1/0)),[d,$]=e;l[d][$]=0,c.enqueue({x:$,y:d,f:0});let u=bresenhamLine(e,t),h=1,p=0;for(;!c.isEmpty();){let m=c.dequeue();if(m.x===t[1]&&m.y===t[0]||dist([m.y,m.x],t)<=i){let _=[],f=m;for(;f;)_.push([f.y-e[0],f.x-e[1]]),f=f.parent;return _.pop(),_.reverse()}if(u.length>=h-1&&(m.y!=u[h-1][0]||m.x!=u[h-1][1])&&(u=bresenhamLine([m.y,m.x],t),h=1),p>n)break;for(let[g,w]of a){let b=m.y+w,v=m.x+g;if(r(b,v)&&2>Math.abs(newgrid[b][v].elevation-newgrid[m.y][m.x].elevation)){let k=l[m.y][m.x]+newgrid[m.y][m.x].moveCost;if(k<l[b][v]){l[b][v]=k;let z=Math.abs(b-t[0]),E=Math.abs(v-t[1]),A;A=z>E?z+.9*E:E+.9*z,u.length>h&&b==u[h][0]&&v==u[h][1]&&(A=-.1);let C=k+A;c.enqueue({x:v,y:b,f:C,parent:m})}}}h++,p++}return null}function processQueue(){if(0===messageQueue.length){isProcessing=!1;return}isProcessing=!0;updategamelog(messageQueue.shift())}function updategamelog(e,t=0){let n=e.split(" ");0==t?gamelog.unshift(n[t]):gamelog[0]+=" "+n[t],++t<n.length?setTimeout(()=>updategamelog(e,t),10):processQueue()}function addToLog(e){messageQueue.push(e),isProcessing||processQueue()}function translateAStoAQ(e,t,n=!1){let i=[],s=[];if(e)for(let o=0;o<e.length;o++)s.push(e[o].map((e,n)=>e+t.pos[n])),0==o?i.push(e[o]):i.push(e[o].map((t,n)=>t-e[o-1][n]));let[a,r]=t.pos;s.length>0&&([a,r]=s[s.length-1]);let c=newgrid[a][r].character,l=newgrid[cursorpos[0]][cursorpos[1]].objects[0],d=!1,$=!1;null!==c&&c.pc!==t.pc&&!1==n&&(d=!0),l&&!1==d&&null!==l.action&&($=!0);let u=[];if(d&&(t.primaryitem.consumable||t.primaryitem.ammotype&&!t.ammunition[t.primaryitem.ammotype]))return u;let h=t.pos,p;$&&dist(h,l.pos)<l.action[3]&&u.push(new action(...l.action,l.pos,t,h));for(let m=0;m<i.length;m++){m>0&&(h=s[m-1]),p=s[m];let _=t.getrange();if(!0==t.primaryitem.throwable&&(_=1.9),d&&dist(h,c.pos)<=_&&!1!==drawline(h,c.pos)){let f=actions.Attack;u.push(new Attack(...f,t.getrange(),c.pos,t,h));break}if($&&dist(h,l.pos)<l.action[3]){u.push(new action(...l.action,l.pos,t,h));break}{let g=[newgrid[s[m][0]][s[m][1]].moveCost,0,0];u.push(new Move("Move",movefunc,g,1,s[m],t,h))}}return u}function moveplayer(){let[e,t]=cursorpos,n=newgrid[e][t];if(!1==n.visible)return;let i=aStar(playercs[activecharacter].pos,cursorpos),s=null;if(n.objects.length>0&&null==n.character){let o=n.objects[0];null!==o.action&&(i=aStar(playercs[activecharacter].pos,cursorpos,50,1.9),s=o.action)}if(i){if(playercs[activecharacter].actionqueue=translateAStoAQ(i,playercs[activecharacter]).slice(),null!==s&&playercs[activecharacter].actionqueue.push(new action(...s,[e,t],playercs[activecharacter])),!0==autodash){let a=0;for(let r=0;r<playercs[activecharacter].actionqueue.length;r++)a+=playercs[activecharacter].actionqueue[r].cost[0];a>playercs[activecharacter].tc[0]&&playercs[activecharacter].tc[1]>=1&&playercs[activecharacter].actionqueue.unshift(new action("Dash",dashfunc,[0,1,0],null,null,playercs[activecharacter]))}playercs[activecharacter].actionqueue.length>0&&playertick()}}function move(e){if(!0==e.dead)return;let[t,n]=e.pos,i=e.actionqueue.shift(),[s,o]=i.target;if(!i)return;let a=e.tc.slice();if(!(e.tc[2]<i.cost[2])){if(e.tc[2]-=i.cost[2],i.reactable&&c(newgrid[t][n],e,i),!(e.tc[0]<i.cost[0])&&!(e.tc[1]<i.cost[1])&&(!e.tc[3]||!i.cost[3]||!(e.tc[3]<i.cost[3]))){if(e.tc[0]-=i.cost[0],e.tc[1]-=i.cost[1],i.cost[3]&&(e.tc[3]-=i.cost[3]),!1!==i.func()){if(i.reactable&&c(newgrid[s][o],e,i),i.loudness){let r=new Sound([s,o],i.loudness,e,i.name);i.soundcontent&&(r.content=i.soundcontent),i.soundeffect&&(r.soundeffect=i.soundeffect),hear(r)}}else e.tc=a.slice();updatetraitspassive(),updatedsomething=!0}}function c(e,t,n){let i={};[e,newgrid[n.target[0]][n.target[1]]].forEach(function(e){e.charactersinview.forEach(function(e){!0==e.pc||!0==e.dead||(i[e.index]=e)}),!0==e.visible&&playercs.forEach(function(e){!1==e.dead&&(i[e.index]=e)}),e.objecttriggers&&e.objecttriggers.forEach(function(i){i.react(e,t,n)})}),Object.values(i).forEach(function(e){e.reactions.forEach(function(i){i(e,t,n)})}),t.reactions.forEach(function(e){e(t,null,null)})}}function addcharlabel(e,t){name=t.name;let[n,i]=e;if(!0==uilock);else{adduilabel(name,e,t.color,2);let s=t.hp,o=s.toString(),a=t.maxhp;for(let r=0;r<t.conditions.length;r++)showdetails&&adduilabel(t.conditions[r].name,e,t.color,r+3);adduilabel(o+"/"+a,e,t.color,1)}}function adduilabel(e,t,n,i,s=!1,o=!1,a=!1,r,c=1){let[l,d]=t;if(newgrid[l]&&newgrid[l][d]){if(chebyshevDistance(viewportpos,t)>viewportsizex/2)return;if(!0===newgrid[l][d].visible||r){let $=Math.ceil(e.length/2-1);if(a&&($=0),!0==o&&($=0),!1==s){for(;;){let u=!1;for(let h=0;h<e.length&&newgrid[l-i]&&newgrid[l-i][d-$+h];h++)newgrid[l-i][d-$+h].uiElements.forEach(function(t){!0!==t.animation&&"$"!==t.symbol&&"$"!==e.charAt(h)&&(u=!0)});if(!1==u||i>10)break;i++}for(let p=0;p<e.length;p++)newgrid[l-i]&&newgrid[l-i][d-$+p]&&newgrid[l-i][d-$+p].uiElements.push(new uielement(e.charAt(p),n,[l-i,d-$+p]))}else{line=[];for(let m=0;m<e.length;m++)line.push([l-i,d-$+m]);addanimation(line,e,n,c,s,r)}}}}function drawGrid(e=!1){let t=performance.now();if(t-lastCall<throttleRate||!1==updatedlighting&&!1==updatedsomething||renderqueue.length>0){!1==checkedframe&&requestAnimationFrame(function(){checkedframe=!1,drawGrid(!0),performance.now()-noiseupdateticker>100&&(noiseupdate(),noiseupdateticker=performance.now())}),checkedframe=!0;return}lastCall=t,adduilabel("x",cursorpos,[128,128,128],0,!1,!1,!1,!0),keyglossary&&Object.values(keybindings).forEach(function(e,t){adduilabel(e,[viewportpos[0],viewportpos[1]-viewportsizex/2],[128,128,128],-(viewportsizey/2)+t+3,!1,!1,!0,!0)}),performance.now(),e&&updatedlighting&&(updatelightmap(),updatedlighting=!1);let n=viewportpos[1]-Math.floor(viewportsizex/2),i=viewportpos[0]-Math.floor(viewportsizey/2),s=viewportpos[1]+Math.floor(viewportsizex/2),o=viewportpos[0]+Math.floor(viewportsizey/2);if(i<0&&(i=0,o=viewportsizey),o>mapsizey&&(o=mapsizey,i=mapsizey-viewportsizey),n<0&&(n=0,s=viewportsizex),s>mapsizex&&(s=mapsizex,n=mapsizex-viewportsizex),Object.values(animationelements).forEach(function(e){let[t,n]=e.pos;newgrid[t][n].uiElements.push(e)}),!1==controllock&&!0==newgrid[cursorpos[0]][cursorpos[1]].visible&&!1==uilock){let a=alinedraw(aStar(playercs[activecharacter].pos,cursorpos),playercs[activecharacter].tc,playercs[activecharacter]);newgrid[cursorpos[0]][cursorpos[1]].cursorread(),R(a)}else if(!0==uilock){let r=!1,c=playercs[activecharacter];c.tc[1]<1&&(uilock=!1);let l=new Attack(...actions.Attack,c.getrange(),cursorpos,c,c.pos),d=l.range,$=Math.ceil(l.range),u=c.getminrange();for(let h=c.pos[0]-$;h<=c.pos[0]+$;h++)for(let p=c.pos[1]-$;p<=c.pos[1]+$;p++)if(dist(c.pos,[h,p])<=d){adduilabel("$",[h,p],[.2,.2,.1],0,!1,!1,!1,!0);let m=bresenhamLine(c.pos,cursorpos),_=linecharacter([m[0][0],m[0][1]],[m[m.length-1][0],m[m.length-1][1]]);if(dist(c.pos,cursorpos)<=d&&dist(c.pos,cursorpos)>u){m.shift();for(let f=0;f<m.length;f++){let[g,w]=m[f],b=[0,0,0];newgrid[g][w].readOpacity()>0&&(b=[128,0,0]),!0==newgrid[g][w].visible&&newgrid[g][w].uiElements.push(new uielement(_,b,[0,0]))}}}if(newgrid[cursorpos[0]][cursorpos[1]].character){if((hypoattack=l.func(!0)).errors.length>0)for(let v=0;v<hypoattack.errors.length;v++);else{r=!0;let k=hypoattack.damagerange[0].toString()+"-"+hypoattack.damagerange[1].toString(),z=Math.round(hypoattack.percenthitchance).toString()+"%";adduilabel(z,cursorpos,[(1-hypoattack.percenthitchance/100)*128,hypoattack.percenthitchance/100*128,0],2,!1,!1),adduilabel(k,cursorpos,[128,0,0],1,!1,!1),R(c.tc.map((e,t)=>e-l.cost[t]));for(let E=0;E<hypoattack.modbreakdown.length;E++)adduilabel(hypoattack.modbreakdown[E],cursorpos,[128,128,128],[E+3],!1,!1)}}!1==r&&R()}else activecharacternonindex&&!0==activecharacternonindex.pc&&R();if(!1==controllock){let A=playercs[activecharacter];newgrid[A.pos[0]][A.pos[1]].uiElements.push(new uielement("",[0,.25,0],playercs[activecharacter].pos))}let C='<span style ="line-height: 1"></span>';for(let S=i;S<o;S++)for(let j=n;j<s;j++)C+=newgrid[S][j].read(),j==s-1&&(C+=`<br><span style ="line-height: 1; font-size: ${fontsize}px;"></span>`);function R(e=activecharacternonindex.tc){let t=activecharacternonindex,n=t.tc.slice(),i="",s="",o="";for(let a=0;a<n[0];a++)a<e[0]?s+="o":s+="x";for(let r=n[0];r<t.tcmax[0];r++)s+=".";for(let c=0;c<n[1];c++)c<e[1]?i+="o":i+="x";for(let l=n[1];l<t.tcmax[1];l++)i+=".";for(let d=0;d<t.conditions.length;d++)o+=t.conditions[d].name;let $=viewportsizex/2,u=viewportsizey/2-1;adduilabel(i,[viewportpos[0]+u,viewportpos[1]-$],[128,0,0],1,!1,!1,!0,!0),adduilabel(s,[viewportpos[0]+u,viewportpos[1]-$],[0,128,0],0,!1,!1,!0,!0),adduilabel(o,[viewportpos[0]+u,viewportpos[1]-$],[128,0,0],2,!1,!1,!0,!0);let h=t.primaryitem.name.toString(),p=[128,128,128];t.primaryitem.absorbtion&&(p=convertAbstoColor(t.primaryitem.absorbtion)),adduilabel(h,[viewportpos[0]+u,viewportpos[1]+$-h.length],p,0,!1,!1,!0,!0);let m=t.secondaryitem.name.toString();p=[64,64,64],t.secondaryitem.absorbtion&&(p=convertAbstoColor(t.secondaryitem.absorbtion).map(e=>e/2)),"Unarmed"!==m&&adduilabel(m,[viewportpos[0]+u,viewportpos[1]+$-m.length],p,1,!1,!1,!0,!0);let _=t.offhanditem.name.toString();p=[64,64,64],t.offhanditem.absorbtion&&(p=convertAbstoColor(t.offhanditem.absorbtion).map(e=>e/2)),"Unarmed"!==_&&adduilabel(_,[viewportpos[0]+u,viewportpos[1]+$-_.length],p,2,!1,!1,!0,!0)}renderqueue.push(C),renderedlastframe=!1,renderqueue.length>0?requestAnimationFrame(()=>{performance.now();let e=renderqueue.shift();renderedlastframe=!0,gameText.innerHTML=e,frameticker++,drawGrid(!0),updatedsomething=!1}):drawGrid(!0),uielements=[],performance.now(),Math.floor(performance.now()/1e3)>timeticker&&(timeticker=Math.floor(performance.now()/1e3),console.log(frameticker),frameticker=0)}function drawgamelog(){for(let e=0;e<gamelog.length&&e<5;e++)adduilabel(gamelog[e],[viewportpos[0]+Math.floor(viewportsizey/2)-1,viewportpos[1]-Math.floor(viewportsizex/2)],[256,256,256],e,!1,!0)}function drawline(e,t,n=!1){let[i,s]=e,[o,a]=t,r=newgrid[i][s].elevation,c=newgrid[o][a].elevation;if(r!==c&&!n)return drawLine3D([i,s,r],[o,a,c]);let l=Math.abs(a-s),d=Math.abs(o-i),$=s<a?1:-1,u=i<o?1:-1,h=l-d,p=s,m=i,_=0;for(;;){if(p===a&&m===o)return _;if((p!=s||m!=i)&&(_+=newgrid[m][p].readOpacity(r)),_>=1)return!1;let f=2*h;f>-d&&(h-=d,p+=$),f<l&&(h+=l,m+=u),f>-d&&f<l&&cornershadows&&(1==newgrid[m][p-$].readOpacity()&&(_+=.5*newgrid[m][p-$].readOpacity()),1==newgrid[m-u][p].readOpacity()&&(_+=.5*newgrid[m-u][p].readOpacity()))}}function drawLine3D(e,t){let[n,i,s]=e,[o,a,r]=t,c=Math.abs(r-s),l=Math.abs(a-i),d=Math.abs(o-n),$=s<r?1:-1,u=i<a?1:-1,h=n<o?1:-1,p=0,m=n,_=i,f=s,g,w;if(l>=d&&l>=c){g=2*d-l,w=2*c-l;for(let b=0;b<=l;b++){if(m==o&&_==a&&f==r)return p;if((_!=i||m!=n)&&(p+=newgrid[m][_].readOpacity(f)),p>=1)return!1;g>0&&(m+=h,g-=2*l),w>0&&(f+=$,w-=2*l),g+=2*d,w+=2*c,_+=u}}else if(d>=l&&d>=c){g=2*l-d,w=2*c-d;for(let v=0;v<=d;v++){if(m==o&&_==a)return p;if((_!=i||m!=n)&&(p+=newgrid[m][_].readOpacity(f)),p>1)return!1;g>0&&(_+=u,g-=2*d),w>0&&(f+=$,w-=2*d),g+=2*l,w+=2*c,m+=h}}else{g=2*d-c,w=2*l-c;for(let k=0;k<=c;k++){if(m==o&&_==a&&f==r)return p;if((_!=i||m!=n)&&(p+=newgrid[m][_].readOpacity(f)),p>1)return!1;g>0&&(m+=h,g-=2*c),w>0&&(_+=u,w-=2*c),g+=2*d,w+=2*l,f+=$}}}function planturn(e){spot(e);let t=new Map,n=e.state.utilityfunction,i=new ActionNode(e.pos,null,e.tc,0,0,null,-9999,e.primaryitem),s=new PriorityQueue((e,t)=>t.utility-e.utility);s.enqueue(i);let o=i,a=n(i,e),r=0,c=0;for(;!s.isEmpty()&&r<5e3;){r++;let l=s.dequeue(),[d,$]=l.pos,{tc:u,utility:h,damagepotential:p,hazards:m}=l,[_,f]=u,g=!1;if(f<0||_<0)continue;if(h>100){o=l;break}let w=`${d},${$}`;t.has(w)||t.set(w,[]);let b=t.get(w);for(let v of b)if(c++,f<=v.tc[1]&&_<=v.tc[0]&&p<=v.damagepotential&&m>=v.hazards&&h<=v.utility){g=!0;break}if(!g){b.push(l),h>a&&(o=l,a=h);e.state.actions.map(t=>e.actions[t]).forEach(t=>{let i=t(l,e,h);i.length>0&&i.forEach(t=>{t.utility=n(t,e),s.enqueue(t)})})}}return function e(t){let n=[];for(;null!=t.action;)n.unshift(t.action),t=t.parentnode;return n}(o)}function subtractcost(e,t){let n=t.map((t,n)=>t-e.cost[n]);return n}gridinit(),noiseupdate(),updateGrid();class ActionNode{constructor(e,t,n,i,s,o,a,r){this.pos=e,this.action=t,n?this.tc=n.slice():this.tc=[],this.hazards=i,this.damagepotential=s,this.parentnode=o,this.parentutility=a,this.activeweapon=r||this.parentnode.activeweapon}}